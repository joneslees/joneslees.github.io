<!DOCTYPE html>





<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="1. openstack介绍OpenStack 是一系列开源工具（或开源项目）的组合，主要使用池化虚拟资源来构建和管理私有云及公共云。其中的六个项目主要负责处理核心云计算服务，包括计算、网络、存储、身份和镜像服务。还有另外十多个可选项目，用户可把它们捆绑打包，用来创建独特、可部署的云架构。1.1. 云计算模式">
<meta property="og:type" content="article">
<meta property="og:title" content="openstack Stein 版本安装文档">
<meta property="og:url" content="http://yoursite.com/2019/10/31/openstack-stein-e7-89-88-e6-9c-ac-e5-ae-89-e8-a3-85-e6-96-87-e6-a1-a3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. openstack介绍OpenStack 是一系列开源工具（或开源项目）的组合，主要使用池化虚拟资源来构建和管理私有云及公共云。其中的六个项目主要负责处理核心云计算服务，包括计算、网络、存储、身份和镜像服务。还有另外十多个可选项目，用户可把它们捆绑打包，用来创建独特、可部署的云架构。1.1. 云计算模式">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824165254114.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824140904824.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824143744924.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824160000868.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824150425310.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824150749828.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/2019082415150929.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824152312712.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824152450891.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/2019082415300566.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824153509883.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824153924205.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824155934803.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824161529433.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824161516324.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824161927287.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824162349681.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824164929553.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824164637115.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824165032811.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824170043956.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821161824988.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821161840997.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821203140535.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821212244679.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821212358175.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821212536714.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/2019082121261795.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821213002110.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821213101430.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821213002110.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821213829262.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821213915398.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190821214130253.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822101338667.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822113418188.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822113631579.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822141041432.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822141054191.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822141105300.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822141002499.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822141023445.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822142050703.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822160644190.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822160621744.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/201908221607110.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/2019082216072774.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822160737790.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822160529397.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822161208129.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822171147536.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824102538440.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822175242214.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822210913280.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190822211003897.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823112544318.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823112818250.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823161053511.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823161148819.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/2019082317351970.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173530683.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173457792.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/2019082317344048.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173421873.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173547914.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173602864.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173651439.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173703934.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173732127.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823173944911.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823174117557.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823174158246.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190823175738137.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824170043956.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190827103209845.png">
<meta property="og:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190827143957233.png">
<meta property="og:updated_time" content="2019-11-16T07:42:20.269Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="openstack Stein 版本安装文档">
<meta name="twitter:description" content="1. openstack介绍OpenStack 是一系列开源工具（或开源项目）的组合，主要使用池化虚拟资源来构建和管理私有云及公共云。其中的六个项目主要负责处理核心云计算服务，包括计算、网络、存储、身份和镜像服务。还有另外十多个可选项目，用户可把它们捆绑打包，用来创建独特、可部署的云架构。1.1. 云计算模式">
<meta name="twitter:image" content="http://www.pever.cn/wp-content/uploads/2019/10/20190824165254114.png">
  <link rel="canonical" href="http://yoursite.com/2019/10/31/openstack-stein-e7-89-88-e6-9c-ac-e5-ae-89-e8-a3-85-e6-96-87-e6-a1-a3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>openstack Stein 版本安装文档 | Hexo</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
        
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-board">
      
    

    <a href="/board" rel="section"><i class="fa fa-fw fa-question-circle"></i>Board</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      
    
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/31/openstack-stein-e7-89-88-e6-9c-ac-e5-ae-89-e8-a3-85-e6-96-87-e6-a1-a3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            openstack Stein 版本安装文档
            

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-31 14:35:43" itemprop="dateCreated datePublished" datetime="2019-10-31T14:35:43+08:00">2019-10-31</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-16 15:42:20" itemprop="dateModified" datetime="2019-11-16T15:42:20+08:00">2019-11-16</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/成长之旅/" itemprop="url" rel="index">
                    <span itemprop="name">成长之旅</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824165254114.png" alt></p><h1 id="1-openstack介绍"><a href="#1-openstack介绍" class="headerlink" title="1. openstack介绍"></a>1. openstack介绍</h1><p>OpenStack 是一系列开源工具（或开源项目）的组合，主要使用池化虚拟资源来构建和管理私有云及公共云。其中的六个项目主要负责处理核心云计算服务，包括计算、网络、存储、身份和镜像服务。还有另外十多个可选项目，用户可把它们捆绑打包，用来创建独特、可部署的云架构。</p><h2 id="1-1-云计算模式"><a href="#1-1-云计算模式" class="headerlink" title="1.1. 云计算模式"></a>1.1. 云计算模式</h2><a id="more"></a>

<p>一、IaaS：基础设施即服务（个人比较习惯的）：用户通过网络获取虚机、存储、网络，然后用户根据自己的需求操作获取的资源 二、PaaS：平台即服务：将软件研发平台作为一种服务， 如Eclipse/Java编程平台，服务商提供编程接口/运行平台等 三、SaaS：软件即服务 ：将软件作为一种服务通过网络提供给用户，如web的电子邮件、HR系统、订单管理系统、客户关系系统等。用户无需购买软件，而是向提供商租用基于web的软件，来管理企业经营活动</p>
<h1 id="2-OpenStack-中有哪些项目？"><a href="#2-OpenStack-中有哪些项目？" class="headerlink" title="2. OpenStack 中有哪些项目？"></a>2. OpenStack 中有哪些项目？</h1><p>OpenStack 架构由大量开源项目组成。其中包含 6 个稳定可靠的核心服务，用于处理计算、网络、存储、身份和镜像； 同时，还为用户提供了十多种开发成熟度各异的可选服务。OpenStack 的 6 个核心服务主要担纲系统的基础架构，其余项目则负责管理控制面板、编排、裸机部署、信息传递、容器及统筹管理等操作。 1. <strong>keystone</strong>：Keystone 认证所有 OpenStack 服务并对其进行授权。同时，它也是所有服务的端点目录。 2. <strong>glance</strong>：Glance 可存储和检索多个位置的虚拟机磁盘镜像。 3. <strong>nova</strong>：是一个完整的OpenStack 计算资源管理和访问工具，负责处理规划、创建和删除操作。 4. <strong>neutron</strong>：Neutron 能够连接其他 OpenStack 服务并连接网络。 5. <strong>dashboard</strong>：web管理界面 6. <strong>Swift</strong>： 是一种高度容错的对象存储服务，使用 RESTful API 来存储和检索非结构数据对象。 7. <strong>Cinder</strong> 通过自助服务 API 访问持久块存储。 8. <strong>Ceilometer</strong>：计费 9. <strong>Heat</strong>：编排 openstack基本架构 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824140904824.png" alt="在这里插入图片描述"> 通过消息队列和数据库，各个组件可以相互调用，互相通信。每个项目都有各自的特性，大而全的架构并非适合每一个用户，如Glance在最早的A、B版本中并没有实际出现应用，Nova可以脱离镜像服务独立运行。当用户的云计算规模大到需要管理多种镜像时，才需要像Glance这样的组件。 OpenStack的逻辑架构 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824143744924.png" alt="在这里插入图片描述"></p>
<hr>
<h2 id="2-1-Openstack创建实例的流程"><a href="#2-1-Openstack创建实例的流程" class="headerlink" title="2.1. Openstack创建实例的流程"></a>2.1. Openstack创建实例的流程</h2><ol>
<li>通过登录界面dashboard或命令行CLI通过<code>RESTful API</code>向<code>keystone</code>获取认证信息。</li>
<li><code>keystone</code>通过用户请求认证信息，并生成<code>auth-token</code>返回给对应的认证请求。</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824160000868.png" alt="在这里插入图片描述"></p>
<hr>
<ol start="3">
<li>然后携带<code>auth-token</code>通过<code>RESTful API</code>向<code>nova-api</code>发送一个<code>boot instance</code>的请求。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824150425310.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="4">
<li><code>nova-api</code>接受请求后向<code>keystone</code>发送认证请求，查看token是否为有效用户和token。</li>
<li>keystone验证token是否有效，将结果返回给<code>nova-api</code>。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824150749828.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="6">
<li>通过认证后nova-api和数据库通讯，初始化新建虚拟机的数据库记录。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/2019082415150929.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="7">
<li><code>nova-api</code>调用<code>rabbitmq</code>，向<code>nova-scheduler</code>请求是否有创建虚拟机的资源(node主机)。</li>
<li><code>nova-scheduler</code>进程侦听消息队列，获取nova-api的请求。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824152312712.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="9">
<li><code>nova-scheduler</code>通过查询nova数据库中计算资源的情况，并通过调度算法计算符合虚拟机创建需要的主机。</li>
<li>对于有符合虚拟机创建的主机，<code>nova-scheduler</code>更新数据库中虚拟机对应的物理主机信息。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824152450891.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="11">
<li><code>nova-scheduler</code>通过rpc调用向<code>nova-compute</code>发送对应的创建虚拟机请求的消息。 <code>nova-compute</code>会从对应的消息队列中获取创建虚拟机请求的消息。</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/2019082415300566.png" alt="在这里插入图片描述"></p>
<hr>
<ol start="12">
<li><code>nova-compute</code>通过rpc调用向<code>nova-conductor</code>请求获取虚拟机消息。（Flavor） <code>nova-conductor</code>从消息队队列中拿到<code>nova-compute</code>请求消息。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824153509883.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="13">
<li><code>nova-conductor</code>根据消息查询虚拟机对应的信息。 <code>nova-conductor</code>从数据库中获得虚拟机对应信息。</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824153924205.png" alt="在这里插入图片描述"></p>
<hr>
<ol start="14">
<li><code>nova-conductor</code>把虚拟机信息通过消息的方式发送到消息队列中。 <code>nova-compute</code>从对应的消息队列中获取虚拟机信息消息。</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824155934803.png" alt="在这里插入图片描述"></p>
<hr>
<ol start="15">
<li><code>nova-compute</code>请求<code>glance-api</code>获取创建虚拟机所需要镜像。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824161529433.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="16">
<li><code>glance-api</code>向<code>keystone</code>认证token是否有效，并返回验证结果。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824161516324.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="17">
<li>token验证通过，<code>nova-compute</code>获得虚拟机镜像信息(URL)。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824161927287.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="18">
<li><code>nova-compute</code>请求<code>neutron-server</code>获取创建虚拟机所需要的网络信息。</li>
<li><code>neutron-server</code>向keystone认证token是否有效，并返回验证结果。</li>
<li>token验证通过，<code>nova-compute</code>获得虚拟机网络信息。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824162349681.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="21">
<li><code>nova-compute</code>请求<code>cinder-api</code>获取创建虚拟机所需要的持久化存储信息。</li>
<li><code>cinder-api</code>向keystone认证token是否有效，并返回验证结果。</li>
<li>token验证通过，<code>nova-compute</code>获得虚拟机持久化存储信息。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824164929553.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<ol start="24">
<li><code>nova-compute</code>根据instance的信息调用配置的虚拟化驱动来创建虚拟机。 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824164637115.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<h2 id="2-2-总图"><a href="#2-2-总图" class="headerlink" title="2.2. 总图"></a>2.2. 总图</h2><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824165032811.png" alt="在这里插入图片描述"></p>
<hr>
<h1 id="3-openstack项目搭建"><a href="#3-openstack项目搭建" class="headerlink" title="3. openstack项目搭建"></a>3. openstack项目搭建</h1><p><strong>1、环境布署</strong> 2、配置keystone服务 3、配置glance服务 4、配置placement服务 5、配置nova服务控制节点 6、配置nova服务计算节点 7、配置neutron服务控制节点 8、配置neutron服务计算节点 9、创建实例 10、配置dashboard服务 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824170043956.png" alt="在这里插入图片描述"></p>
<blockquote>
<p>图中数字，如10，表示ip：192.168.99.10</p>
</blockquote>
<hr>
<h1 id="4-环境配置"><a href="#4-环境配置" class="headerlink" title="4. 环境配置"></a>4. 环境配置</h1><ol>
<li><p>系统： 计算节点：centos 7.2.1511 其它：centos 7.6.1810</p>
</li>
<li><p>准备yum源：<code>/etc/yum.repos.d/openstack.repo</code></p>
<p>yum install centos-release-openstack-stein</p>
</li>
<li><p>安装openstack客户端、openstack SELinux管理包（控制端与计算节点安装，其它不需要）</p>
<p>yum install python-openstackclient openstack-selinux</p>
</li>
<li><p>更改主机名</p>
<p>hostnamectl set-hostname 主机名</p>
</li>
<li><p>时间同步</p>
<p>cp -f /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime<br>ntpdate  time3.aliyun.com &amp;&amp; hwclock  -w</p>
</li>
<li><p>配置hosts</p>
<p>echo “192.168.99.100 openstackvip.com” &gt;&gt; /etc/hosts</p>
</li>
</ol>
<blockquote>
<p>这里设置你的vip和你的域名</p>
</blockquote>
<ol start="6">
<li><p>如果你做bond，就做这步，否则就跳过。 <strong>bond配置</strong></p>
<p>cd /etc/sysconfig/network-scripts/</p>
<p>vim ifcfg-bond0 </p>
<p>BOOTPROTO=static<br>NAME=bond0<br>DEVICE=bond0<br>ONBOOT=yes<br>BONDING_MASTER=yes<br>BONDING_OPTS=”mode=1 miimon=100” #指定绑定类型为1及链路状态监测间隔时间<br>IPADDR=192.168.99.101<br>NETMASK=255.255.255.0<br>GATEWAY=192.168.99.2<br>DNS1=202.106.0.20</p>
</li>
</ol>
<p><strong>eth0配置：</strong></p>
<pre><code>vim ifcfg-eth0 

BOOTPROTO=static
NAME=eth0
DEVICE=eth0
ONBOOT=yes
NM_CONTROLLED=no
MASTER=bond0
USERCTL=no
SLAVE=yes</code></pre><p><strong>eth1配置：</strong></p>
<pre><code>vim ifcfg-eth1

BOOTPROTO=static
NAME=eth1
DEVICE=eth1
ONBOOT=yes
NM_CONTROLLED=no
MASTER=bond0
USERCTL=no
SLAVE=yes</code></pre><hr>
<h2 id="4-1-配置SQL数据库"><a href="#4-1-配置SQL数据库" class="headerlink" title="4.1. 配置SQL数据库"></a>4.1. 配置SQL数据库</h2><blockquote>
<ul>
<li>在数据库节点上配置</li>
</ul>
<ol>
<li>安装组件</li>
</ol>
</blockquote>
<pre><code>yum -y install  mariadb mariadb-server </code></pre><ol start="2">
<li><p>配置my.cnf</p>
<p>vim /etc/my.cnf.d/openstack.cnf</p>
<p>[mysqld]<br>bind-address = 192.168.99.106<br>default-storage-engine = innodb<br>innodb_file_per_table = on<br>max_connections = 4096<br>collation-server = utf8_general_ci<br>character-set-server = utf8</p>
</li>
</ol>
<ol start="3">
<li><p>启动数据库和设置开机启动</p>
<p>systemctl enable mariadb.service<br>systemctl restart mariadb.service</p>
</li>
<li><p>通过运行脚本来保护数据库服务</p>
<p>mysql_secure_installation</p>
</li>
</ol>
<hr>
<h2 id="4-2-配置Memcached"><a href="#4-2-配置Memcached" class="headerlink" title="4.2. 配置Memcached"></a>4.2. 配置Memcached</h2><blockquote>
<ul>
<li>在数据库节点上配置</li>
</ul>
<ol>
<li>安装包：</li>
</ol>
</blockquote>
<pre><code>yum -y install memcached python-memcached</code></pre><ol start="2">
<li><p>编辑配置文件 配置服务以使用控制器节点的管理IP地址。这是为了通过网络访问其他节点：</p>
<p>vim /etc/sysconfig/memcached</p>
</li>
</ol>
<p>替换下面这句</p>
<pre><code>OPTIONS=&quot;-l 192.168.99.106&quot;</code></pre><ol start="3">
<li><p>启动Memcached服务并将其配置为在系统引导时启动：</p>
<p>systemctl enable memcached.service<br>systemctl restart memcached.service</p>
</li>
</ol>
<hr>
<h2 id="4-3-安装rabbit-MQ"><a href="#4-3-安装rabbit-MQ" class="headerlink" title="4.3. 安装rabbit-MQ"></a>4.3. 安装rabbit-MQ</h2><blockquote>
<ul>
<li>在数据库节点上配置</li>
</ul>
</blockquote>
<ol start="7">
<li><p>安装</p>
<p>yum -y install rabbitmq-server</p>
</li>
<li><p>启动(端口15672)</p>
<p>systemctl enable rabbitmq-server<br>systemctl restart rabbitmq-server</p>
</li>
<li><p>添加用户和密码</p>
<p>rabbitmqctl add_user openstack 123</p>
</li>
</ol>
<p>授权</p>
<pre><code>rabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</code></pre><ol start="11">
<li><p>打开web插件</p>
<p>rabbitmq-plugins enable rabbitmq_management</p>
</li>
<li><p>查看插件</p>
<p>rabbitmq-plugins list</p>
</li>
<li><p>web访问端口15672，用户密码都是guest</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821161824988.png" alt="在这里插入图片描述"> <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821161840997.png" alt="在这里插入图片描述"></p>
<hr>
<h1 id="5-配置haproxy-keepalived"><a href="#5-配置haproxy-keepalived" class="headerlink" title="5. 配置haproxy+keepalived"></a>5. 配置haproxy+keepalived</h1><blockquote>
<ul>
<li>在haproxy节点上配置</li>
</ul>
</blockquote>
<ol>
<li><p>安装keepalived和haproxy</p>
<p>yum -y install keepalived haproxy</p>
</li>
<li><p>配置master_keepalived</p>
<p>vim /etc/keepalived/keepalived.conf</p>
<p>! Configuration File for keepalived</p>
<p>global_defs {<br>   notification_email {</p>
<pre><code>root@localhost</code></pre><p>   }<br>   notification_email_from keepalived@localhost<br>   smtp_server 127.0.0.1<br>   smtp_connect_timeout 30<br>   router_id ha_1<br>   vrrp_skip_check_adv_addr<br>   vrrp_strict<br>   vrrp_iptables<br>   vrrp_garp_interval 0<br>   vrrp_gna_interval 0<br>}<br>vrrp_instance VI_1 {</p>
<pre><code>state MASTER
interface eth0
virtual_router_id 51
priority 100
advert_int 1
authentication {
    auth_type PASS
    auth_pass 1111
}
virtual_ipaddress {
    192.168.99.100 dev eth0 label eth0:1
}</code></pre><p>}</p>
</li>
<li><p>启动</p>
<p>systemctl restart keepalived<br>systemctl enable keepalived</p>
</li>
<li><p>haproxy配置</p>
<p>vim /etc/haproxy/haproxy.cfg</p>
<p>global</p>
<pre><code>log         127.0.0.1 local2
chroot      /var/lib/haproxy
pidfile     /var/run/haproxy.pid
maxconn     4000
user        haproxy
group       haproxy
daemon
stats socket /var/lib/haproxy/stats</code></pre><p>defaults</p>
<pre><code>mode                    http
log                     global
option                  httplog
option                  dontlognull
option http-server-close
option forwardfor       except 127.0.0.0/8
option                  redispatch
retries                 3
timeout http-request    180s
timeout queue           10m
timeout connect         180s
timeout client          10m
timeout server          10m
timeout http-keep-alive 180s
timeout check           10s
maxconn                 3000</code></pre><p>listen stats</p>
<pre><code>mode http
bind :9999
stats enable
log global
stats uri /haproxy-status
stats auth admin:123</code></pre><p>listen dashboard</p>
<pre><code>bind :80
mode http
balance source
server dashboard 192.168.99.106:80 check inter 2000 fall 3 rise 5</code></pre><p>listen mysql</p>
<pre><code>bind :3306
mode tcp
balance source
server mysql 192.168.99.106:3306 check inter 2000 fall 3 rise 5</code></pre><p>listen memcached</p>
<pre><code>bind :11211
mode tcp
balance source
server memcached 192.168.99.106:11211 inter 2000 fall 3 rise 5</code></pre><p>listen rabbit</p>
<pre><code>bind :5672
mode tcp
server rabbit 192.168.99.106:5672 inter 2000 fall 3 rise 5</code></pre><p>listen rabbit_web</p>
<pre><code>bind :15672
mode http
server rabbit_web 192.168.99.106:15672 inter 2000 fall 3 rise 5</code></pre><p>listen keystone</p>
<pre><code>bind :5000
mode tcp
server keystone 192.168.99.101:5000 inter 2000 fall 3 rise 5</code></pre><p>listen glance</p>
<pre><code>bind :9292
mode tcp
server glance 192.168.99.101:9292 inter 2000 fall 3 rise 5</code></pre><p>listen placement</p>
<pre><code>bind :8778
mode tcp
server placement 192.168.99.101:8778 inter 2000 fall 3 rise 5</code></pre><p>listen neutron</p>
<pre><code>bind :9696
mode tcp
server neutron 192.168.99.101:9696 inter 2000 fall 3 rise 5</code></pre><p>listen nova</p>
<pre><code>bind :8774
mode tcp
server nova 192.168.99.101:8774 inter 2000 fall 3 rise 5</code></pre><p>listen VNC</p>
<pre><code>bind :6080
mode tcp
server VNC 192.168.99.101:6080 inter 2000 fall 3 rise 5</code></pre></li>
<li><p>启动</p>
<p>systemctl restart haproxy<br>systemctl enable haproxy</p>
</li>
</ol>
<p>查检下端口</p>
<pre><code>ss -tnl

# 输出
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port
LISTEN     0      128      *:5000                 *:*
LISTEN     0      128      *:5672                 *:*
LISTEN     0      128      *:8778                 *:*
LISTEN     0      128      *:3306                 *:*
LISTEN     0      128      *:11211                *:*
LISTEN     0      128      *:9292                 *:*
LISTEN     0      128      *:9999                 *:*
LISTEN     0      128      *:80                   *:*
LISTEN     0      128      *:22                   *:*
LISTEN     0      128      *:15672                *:*
LISTEN     0      100    127.0.0.1:25                   *:*             
LISTEN     0      128      *:6080                 *:*
LISTEN     0      128      *:9696                 *:*
LISTEN     0      128      *:8774                 *:*
LISTEN     0      128     :::22                  :::*
LISTEN     0      100    ::1:25                  :::*</code></pre><ol start="7">
<li><p>配置内核参数</p>
<p>echo “net.ipv4.ip_nonlocal_bind=1” &gt;&gt; /etc/sysctl.conf</p>
</li>
</ol>
<blockquote>
<p>启动haproxy的时候，允许忽视VIP的存在</p>
</blockquote>
<pre><code>echo &quot;net.ipv4.ip_forward=1&quot; &gt;&gt; /etc/sysctl.conf</code></pre><blockquote>
<p>允许ip转发</p>
</blockquote>
<pre><code>sysctl -p</code></pre><blockquote>
<p>使之生效</p>
</blockquote>
<hr>
<h1 id="6-配置keystone认证服务"><a href="#6-配置keystone认证服务" class="headerlink" title="6. 配置keystone认证服务"></a>6. 配置keystone认证服务</h1><h2 id="6-1-数据库：106"><a href="#6-1-数据库：106" class="headerlink" title="6.1. 数据库：106"></a>6.1. 数据库：106</h2><p>keystone数据库配置</p>
<pre><code>[mysql]$ mysql -uroot -p123

MariaDB [(none)]&gt; create database keystone;
MariaDB [(none)]&gt; grant all on keystone.* to keystone@&apos;%&apos; identified by &apos;123&apos;;</code></pre><h2 id="6-2-控制端-101"><a href="#6-2-控制端-101" class="headerlink" title="6.2. 控制端: 101"></a>6.2. 控制端: 101</h2><ol>
<li><p>安装插件</p>
<p>yum -y install python2-PyMySQL mariadb</p>
</li>
</ol>
<p><strong>控制端</strong>上测试</p>
<pre><code>mysql -ukeystone -h 192.168.99.106 -p123</code></pre><p>在<strong>控制端</strong>添加host文件：<code>/etc/hosts</code></p>
<pre><code>192.168.99.100 openstackvip.com</code></pre><p><strong>配置keystone</strong> 1. 安装</p>
<pre><code>yum -y install openstack-keystone httpd mod_wsgi python-memcached</code></pre><ol start="2">
<li><p>生成临时token</p>
<p>openssl rand -hex 10</p>
</li>
</ol>
<p>输出，记住ta，有用</p>
<pre><code>db148a2487000ad12b90</code></pre><ol start="3">
<li><p>配置<code>/etc/keystone/keystone.conf</code></p>
<p>sed -i.bak -e ‘/^#/d’ -e ‘/^$/d’ /etc/keystone/keystone.conf</p>
<p>vim /etc/keystone/keystone.conf</p>
<p>[DEFAULT]<br>admin_token = db148a2487000ad12b90</p>
<p>[access_rules_config]<br>[application_credential]<br>[assignment]<br>[auth]<br>[cache]<br>[catalog]<br>[cors]<br>[credential]</p>
<p>[database]<br>connection = mysql+pymysql://keystone:<a href="mailto:123@openstackvip.com" target="_blank" rel="noopener">123@openstackvip.com</a>/keystone</p>
<p>[domain_config]<br>[endpoint_filter]<br>[endpoint_policy]<br>[eventlet_server]<br>[federation]<br>[fernet_receipts]<br>[fernet_tokens]<br>[healthcheck]<br>[identity]<br>[identity_mapping]<br>[jwt_tokens]<br>[ldap]<br>[memcache]<br>[oauth1]<br>[oslo_messaging_amqp]<br>[oslo_messaging_kafka]<br>[oslo_messaging_notifications]<br>[oslo_messaging_rabbit]<br>[oslo_middleware]<br>[oslo_policy]<br>[policy]<br>[profiler]<br>[receipt]<br>[resource]<br>[revoke]<br>[role]<br>[saml]<br>[security_compliance]<br>[shadow_users]<br>[signing]</p>
<p>[token]<br>provider = fernet</p>
<p>[tokenless_auth]<br>[trust]<br>[unified_limit]<br>[wsgi]</p>
</li>
<li><p>填充Identity服务数据库</p>
<p>su -s /bin/sh -c “keystone-manage db_sync” keystone</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821203140535.png" alt="在这里插入图片描述"></p>
<ol start="5">
<li><p>初始化Fernet密钥存储库</p>
<p>keystone-manage fernet_setup –keystone-user keystone –keystone-group keystone<br>keystone-manage credential_setup –keystone-user keystone –keystone-group keystone</p>
</li>
</ol>
<p>验证：</p>
<pre><code>ls /etc/keystone/fernet-keys/

1 0</code></pre><ol start="6">
<li><p>配置apache配置文件<code>/etc/httpd/conf/httpd.conf</code> 加配置<code>Servername controller:80</code></p>
<p>sed -i ‘1s#$#\nServername controller:80#’ /etc/httpd/conf/httpd.conf</p>
</li>
<li><p>软链接配置文件</p>
<p>ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/</p>
</li>
<li><p>启动Apache HTTP服务</p>
<p>systemctl enable httpd.service<br>systemctl restart httpd.service</p>
</li>
<li><p>配置管理帐户</p>
<p>export OS_TOKEN=db148a2487000ad12b90<br>export OS_URL=<a href="http://openstackvip.com:5000/v3" target="_blank" rel="noopener">http://openstackvip.com:5000/v3</a><br>export OS_IDENTITY_API_VERSION=3</p>
</li>
</ol>
<p>验证下：</p>
<pre><code>openstack domain list

The request you have made requires authentication. (HTTP 401) (Request-ID: req-03ea8186-0af9-4fa8-ba53-d043cd28e2c0)</code></pre><p>这里出错了，检查下你的token，OS_TOKEN设置变量的时候是不是没有跟你在<code>/etc/keystone/keystone.conf</code>配置文件中设置的TOKEN的一样，改成一样的就可以了。</p>
<pre><code>openstack domain list</code></pre><p>输出是空的就对了，因为我们还没有添加</p>
<ol start="10">
<li><p>创建新域的正式方法</p>
<p>openstack domain create –description “exdomain” default</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821212244679.png" alt="在这里插入图片描述"> 11. 创建项目admin</p>
<pre><code>openstack project create --domain default \
  --description &quot;Admin Project&quot; admin</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821212358175.png" alt="在这里插入图片描述"></p>
<ol start="12">
<li><p>创建admin，密码设置123</p>
<p>openstack user create –domain default –password-prompt admin</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821212536714.png" alt="在这里插入图片描述"></p>
<ol start="13">
<li><p>创建角色</p>
<p>openstack role create admin</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/2019082121261795.png" alt="在这里插入图片描述"></p>
<ol start="14">
<li><p>给admin用户授权</p>
<p>openstack role add –project admin –user admin admin</p>
</li>
<li><p>创建demo项目</p>
<p>openstack project create –domain default –description “Demo project” demo</p>
</li>
<li><p>给demo创建用户</p>
<p>openstack user create –domain default –password-prompt demo</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821213002110.png" alt="在这里插入图片描述"></p>
<ol start="17">
<li><p>创建user角色（现在就有user和admin）</p>
<p>openstack role create user</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821213101430.png" alt="在这里插入图片描述"></p>
<ol start="18">
<li><p>给demo用户授权user</p>
<p>openstack role add –project demo –user demo user</p>
</li>
<li><p>创建service项目</p>
<p>openstack project create –domain default –description “service project” service</p>
</li>
<li><p>创建用户glance</p>
<p>openstack user create –domain default –password-prompt glance</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821213002110.png" alt="在这里插入图片描述"></p>
<ol start="21">
<li><p>给service添加glance用户并授权admin角色</p>
<p>openstack role add –project service –user glance admin</p>
</li>
<li><p>创建nova、neutron用户并授权</p>
<p>openstack user create –domain default –password-prompt nova</p>
<p>openstack role add –project service –user nova admin</p>
</li>
<li><p>创建keystone的认证服务</p>
<p>openstack service create –name keystone –description “openstack identify” identity</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821213829262.png" alt="在这里插入图片描述"></p>
<ol start="25">
<li><p>查看服务列表</p>
<p>openstack service list</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821213915398.png" alt="在这里插入图片描述"></p>
<ol start="26">
<li><p>创建endpoint,地址写vip 公共端点</p>
<p>openstack endpoint create –region RegionOne identity public <a href="http://openstackvip.com:5000/v3" target="_blank" rel="noopener">http://openstackvip.com:5000/v3</a></p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190821214130253.png" alt="在这里插入图片描述"> 私有端点</p>
<pre><code>openstack endpoint create --region RegionOne identity internal http://openstackvip.com:5000/v3</code></pre><p>管理端点</p>
<pre><code>openstack endpoint create --region RegionOne identity admin http://openstackvip.com:5000/v3</code></pre><ol start="30">
<li><p>测试keystone能否验证</p>
<p>unset OS_TOKEN</p>
<p>openstack –os-auth-url <a href="http://openstackvip.com:5000/v3" target="_blank" rel="noopener">http://openstackvip.com:5000/v3</a> <br>–os-project-domain-name default <br>–os-user-domain-name default <br>–os-project-name admin <br>–os-username admin token issue</p>
</li>
<li><p>使用脚本配置环境变量 <strong>admin用户脚本</strong><code>keystone_admin.sh</code></p>
<p>#!/bin/bash<br>export OS_PROJECT_DOMAIN_NAME=default<br>export OS_USER_DOMAIN_NAME=default<br>export OS_PROJECT_NAME=admin<br>export OS_USERNAME=admin<br>export OS_PASSWORD=123<br>export OS_AUTH_URL=<a href="http://openstackvip.com:5000/v3" target="_blank" rel="noopener">http://openstackvip.com:5000/v3</a><br>export OS_IDENTITY_API_VERSION=3<br>export OS_IMAGE_API_VERSION=2</p>
</li>
</ol>
<p><strong>demo用户脚本</strong><code>keystone_demo.sh</code></p>
<pre><code>#!/bin/bash
export OS_PROJECT_DOMAIN_NAME=default
export OS_USER_DOMAIN_NAME=default
export OS_PROJECT_NAME=demo
export OS_USERNAME=demo
export OS_PASSWORD=123
export OS_AUTH_URL=http://openstackvip.com:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2</code></pre><hr>
<h1 id="7-配置glance服务"><a href="#7-配置glance服务" class="headerlink" title="7. 配置glance服务"></a>7. 配置glance服务</h1><p>Glance是Openstack镜像服务组件，监听在9292端口，接收REST API请求，通过其它模块来完成镜像的获取，上传，删除等。 在创建虚拟机的时候，先把镜像上传到glace， glance-api接收镜像的删除、上传和读取； glance-registry(port:9191)与mysql交互，存储获取镜像的元数据。 glance数据库有两张表，一张image表，一张image property表：保存了镜像格式、大小等信息 image store是一个存储的接口层，通过这个接口glance可以获取镜像</p>
<ol>
<li><p>控制端安装glance</p>
<p>yum -y install openstack-glance</p>
</li>
<li><p>在数据库数据库与用户</p>
<p>mysql -uroot -p123</p>
<p>MariaDB [(none)]&gt; create database glance;<br>MariaDB [(none)]&gt;  grant all on glance.* to ‘glance’@’%’ identified by ‘123’;</p>
</li>
</ol>
<p>验证glance用户连接</p>
<pre><code>mysql -hopenstackvip.com -uglance -p123</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822101338667.png" alt="在这里插入图片描述"></p>
<ol start="3">
<li><p>编辑配置文件<code>/etc/glance/glance-api.conf</code></p>
<p>sed -i -e ‘/^#/d’ -e ‘/^$/d’  /etc/glance/glance-api.conf</p>
<p>vim /etc/glance/glance-api.conf</p>
</li>
</ol>
<p>最终如下</p>
<pre><code>[DEFAULT]

[cinder]

[cors]

[database]
connection = mysql+pymysql://glance:123@openstackvip.com/glance

[file]
[glance.store.http.store]
[glance.store.rbd.store]
[glance.store.sheepdog.store]
[glance.store.swift.store]
[glance.store.vmware_datastore.store]

[glance_store]
stores = file,http
default_store = file
filesystem_store_datadir = /var/lib/glance/images

[image_format]

[keystone_authtoken]
auth_uri = http://openstackvip.com:5000
auth_url = http://openstackvip.com:5000
memcached_servers = openstackvip.com:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = glance
password = 123

[oslo_concurrency]
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]

[paste_deploy]
flavor = keystone

[profiler]
[store_type_location_strategy]
[task]
[taskflow_executor]</code></pre><ol start="4">
<li><p>编辑配置文件<code>/etc/glance/glance-registry.conf</code></p>
<p>sed -i -e ‘/^#/d’ -e ‘/^$/d’  /etc/glance/glance-registry.conf</p>
<p>vim /etc/glance/glance-registry.conf</p>
</li>
</ol>
<p>最终如下</p>
<pre><code>[DEFAULT]

[database]
connection = mysql+pymysql://glance:123@openstackvip.com/glance

[keystone_authtoken]
auth_uri = http://openstackvip.com:5000
auth_url = http://openstackvip.com:5000
memcached_servers = openstackvip.com:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = glance
password = 123

[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_policy]

[paste_deploy]
flavor = keystone

[profiler]</code></pre><hr>
<ol start="6">
<li><p>初始化glance数据库</p>
<p>su -s /bin/sh -c “glance-manage db_sync” glance</p>
</li>
</ol>
<p>验证数据库 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822113418188.png" alt="在这里插入图片描述"></p>
<ol start="7">
<li><p>启动glance并设置为开机启动</p>
<p>systemctl enable openstack-glance-api.service openstack-glance-registry.service<br>systemctl restart openstack-glance-api.service openstack-glance-registry.service</p>
</li>
</ol>
<p>验证glance端口(30022,9191,9292) <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822113631579.png" alt="在这里插入图片描述"></p>
<ol start="7">
<li><p>glance服务注册(设置环境变量)</p>
<p>source keystone_admin.sh</p>
</li>
<li><p>创建glance服务</p>
<p>openstack service create –name glance –description “OpenStack Image” image</p>
</li>
<li><p>创建公有endpoint</p>
<p>openstack endpoint create –region RegionOne image public <a href="http://openstackvip.com:9292" target="_blank" rel="noopener">http://openstackvip.com:9292</a></p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822141041432.png" alt="在这里插入图片描述"></p>
<ol start="10">
<li><p>创建私有endpoint</p>
<p>openstack endpoint create –region RegionOne image internal <a href="http://openstackvip.com:9292" target="_blank" rel="noopener">http://openstackvip.com:9292</a></p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822141054191.png" alt="在这里插入图片描述"></p>
<ol start="11">
<li><p>创建管理endpoint</p>
<p>openstack endpoint create –region RegionOne image admin   <a href="http://openstackvip.com:9292" target="_blank" rel="noopener">http://openstackvip.com:9292</a></p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822141105300.png" alt="在这里插入图片描述"></p>
<ol start="12">
<li><p>验证以上步骤</p>
<p>openstack endpoint list</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822141002499.png" alt="在这里插入图片描述"></p>
<ol start="13">
<li><p>验证glance服务</p>
<p>glance image-list<br>#与<br>openstack image list</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822141023445.png" alt="在这里插入图片描述"></p>
<ol start="14">
<li><p>测试glance上传镜像</p>
<p>wget <a href="http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img" target="_blank" rel="noopener">http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img</a></p>
</li>
<li><p>创建</p>
<p>openstack image create “cirros” <br>–file  /root/cirros-0.3.4-x86_64-disk.img <br>–disk-format qcow2 <br>–container-format bare <br>–public</p>
</li>
</ol>
<p>Bash</p>
<p>Copy</p>
<p>验证glance镜像</p>
<pre><code>glance image-list
#和
openstack image list</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822142050703.png" alt="在这里插入图片描述"></p>
<ol start="16">
<li><p>查看指定镜像信息</p>
<p>openstack image  show  cirros</p>
<p>+——————+——————————————————————————————————————————————————————————————–+<br>| Field            | Value                                                                                                                                                                                      |<br>+——————+——————————————————————————————————————————————————————————————–+<br>| checksum         | ee1eca47dc88f4879d8a229cc70a07c6                                                                                                                                                           |<br>| container_format | bare                                                                                                                                                                                       |<br>| created_at       | 2019-08-22T06:20:18Z                                                                                                                                                                       |<br>| disk_format      | qcow2                                                                                                                                                                                      |<br>| file             | /v2/images/7ae353f8-db19-4449-b4ac-df1e70fe96f7/file                                                                                                                                       |<br>| id               | 7ae353f8-db19-4449-b4ac-df1e70fe96f7                                                                                                                                                       |<br>| min_disk         | 0                                                                                                                                                                                          |<br>| min_ram          | 0                                                                                                                                                                                          |<br>| name             | cirros                                                                                                                                                                                     |<br>| owner            | 7cbf02c5e55f43938062a9e31e9ea4bb                                                                                                                                                           |<br>| properties       | os_hash_algo=’sha512’, os_hash_value=’1b03ca1bc3fafe448b90583c12f367949f8b0e665685979d95b004e48574b953316799e23240f4f739d1b5eb4c4ca24d38fdc6f4f9d8247a2bc64db25d6bbdb2’, os_hidden=’False’ |<br>| protected        | False                                                                                                                                                                                      |<br>| schema           | /v2/schemas/image                                                                                                                                                                          |<br>| size             | 13287936                                                                                                                                                                                   |<br>| status           | active                                                                                                                                                                                     |<br>| tags             |                                                                                                                                                                                            |<br>| updated_at       | 2019-08-22T06:20:19Z                                                                                                                                                                       |<br>| virtual_size     | None                                                                                                                                                                                       |<br>| visibility       | public                                                                                                                                                                                     |<br>+——————+——————————————————————————————————————————————————————————————–+</p>
</li>
</ol>
<hr>
<h1 id="8-配置placement服务"><a href="#8-配置placement服务" class="headerlink" title="8. 配置placement服务"></a>8. 配置placement服务</h1><h2 id="8-1-数据库"><a href="#8-1-数据库" class="headerlink" title="8.1. 数据库"></a>8.1. 数据库</h2><pre><code>mysql -u root -p

MariaDB [(none)]&gt; CREATE DATABASE placement;

MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON placement.* TO &apos;placement&apos;@&apos;%&apos; \
  IDENTIFIED BY &apos;123&apos;;</code></pre><h2 id="8-2-控制端"><a href="#8-2-控制端" class="headerlink" title="8.2. 控制端"></a>8.2. 控制端</h2><ol>
<li><p>使用您选择的创建Placement服务用户PLACEMENT_PASS</p>
<p>openstack user create –domain default –password-prompt placement</p>
</li>
<li><p>使用admin角色将Placement用户添加到服务项目</p>
<p>openstack role add –project service –user placement admin</p>
</li>
<li><p>在服务目录中创建Placement API条目</p>
<p>openstack service create –name placement <br>  –description “Placement API” placement</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822160644190.png" alt="在这里插入图片描述"></p>
<ol start="4">
<li><p>创建Placement API服务端点</p>
<p>openstack endpoint create –region RegionOne placement public <a href="http://openstackvip.com:8778" target="_blank" rel="noopener">http://openstackvip.com:8778</a></p>
<p>openstack endpoint create –region RegionOne placement internal <a href="http://openstackvip.com:8778" target="_blank" rel="noopener">http://openstackvip.com:8778</a></p>
<p>openstack endpoint create –region RegionOne placement admin <a href="http://openstackvip.com:8778" target="_blank" rel="noopener">http://openstackvip.com:8778</a></p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822160621744.png" alt="在这里插入图片描述"></p>
<ol start="5">
<li><p>安装openstack-placement-api</p>
<p>yum -y install openstack-placement-api</p>
</li>
<li><p>编辑<code>/etc/placement/placement.conf</code></p>
<p>sed -i -e ‘/^#/d’ -e ‘/^$/d’ /etc/placement/placement.conf</p>
<p>vim /etc/placement/placement.conf</p>
<p>[DEFAULT]</p>
<p>[api]<br>auth_strategy = keystone</p>
<p>[keystone_authtoken]<br>auth_url = <a href="http://openstackvip.com:5000/v3" target="_blank" rel="noopener">http://openstackvip.com:5000/v3</a><br>memcached_servers = openstackvip.com:11211<br>auth_type = password<br>project_domain_name = default<br>user_domain_name = default<br>project_name = service<br>username = placement<br>password = 123</p>
<p>[placement]</p>
<p>[placement_database]<br>connection = mysql+pymysql://placement:<a href="mailto:123@openstackvip.com" target="_blank" rel="noopener">123@openstackvip.com</a>/placement</p>
</li>
<li><p>填充placement数据库</p>
<p>su -s /bin/sh -c “placement-manage db sync” placement</p>
</li>
</ol>
<p>Bash</p>
<p>Copy</p>
<ol start="8">
<li><p>重启httpd服务</p>
<p>systemctl restart httpd</p>
</li>
<li><p>验证</p>
<p>placement-status upgrade check</p>
<p>+———————————-+<br>| Upgrade Check Results            |<br>+———————————-+<br>| Check: Missing Root Provider IDs |<br>| Result: Success                  |<br>| Details: None                    |<br>+———————————-+<br>| Check: Incomplete Consumers      |<br>| Result: Success                  |<br>| Details: None                    |<br>+———————————-+</p>
</li>
</ol>
<hr>
<h1 id="9-配置nova"><a href="#9-配置nova" class="headerlink" title="9. 配置nova"></a>9. 配置nova</h1><h2 id="9-1-配置nova控制节点"><a href="#9-1-配置nova控制节点" class="headerlink" title="9.1. 配置nova控制节点"></a>9.1. 配置nova控制节点</h2><p>nova分为控制节点和计算节点，计算节点通过nova computer进行虚拟机创建，通过libvirt调用kvm创建虚拟机，nova之间通信通过rabbitMQ队列进行通信 <strong>其组件和功能如下：</strong> API：负责接收和响应外部请求。 Scheduler：负责调度虚拟机所在的物理机。 Conductor：计算节点访问数据库的中间件。 Consoleauth：用于控制台的授权认证。 Novncproxy：VNC 代理，用于显示虚拟机操作终端。 <strong>Nova-API的功能：</strong> Nova-api组件实现了restful API的功能，接收和响应来自最终用户的计算API请求，接收外部的请求并通过message queue将请求发动给其他服务组件，同时也兼容EC2 API，所以也可以使用EC2的管理工具对nova进行日常管理。 <strong>nova scheduler：</strong> nova scheduler模块在openstack中的作用是决策虚拟机创建在哪个主机（计算节点）上。决策一个虚拟机应该调度到某物理节点，需要分为两个步骤： 过滤（filter）：过滤出可以创建虚拟机的主机 计算权值（weight）：根据权重大进行分配，默认根据资源可用空间进行权重排序</p>
<hr>
<h3 id="9-1-1-安装并配置nova控制节点"><a href="#9-1-1-安装并配置nova控制节点" class="headerlink" title="9.1.1. 安装并配置nova控制节点"></a>9.1.1. 安装并配置nova控制节点</h3><p>在数据库服务器操作 1. 准备数据库</p>
<pre><code>mysql -uroot -p123

MariaDB [(none)]&gt; CREATE DATABASE nova_api;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_api.* TO &apos;nova&apos;@&apos;%&apos; IDENTIFIED BY &apos;123&apos;;

MariaDB [(none)]&gt; CREATE DATABASE nova;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO &apos;nova&apos;@&apos;%&apos;  IDENTIFIED BY &apos;123&apos;;

MariaDB [(none)]&gt; CREATE DATABASE nova_cell0;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_cell0.* TO &apos;nova&apos;@&apos;%&apos; IDENTIFIED BY &apos;123&apos;;

MariaDB [(none)]&gt; flush privileges;</code></pre><hr>
<h3 id="9-1-2-在控制端"><a href="#9-1-2-在控制端" class="headerlink" title="9.1.2. 在控制端"></a>9.1.2. 在控制端</h3><ol>
<li><p>安装</p>
<p>yum -y install openstack-nova-api openstack-nova-conductor <br>  openstack-nova-console openstack-nova-novncproxy  <br>  openstack-nova-scheduler </p>
</li>
<li><p>创建nova服务(类型compute)</p>
<p>openstack service create –name nova <br>  –description “OpenStack Compute” compute</p>
</li>
<li><p>创建公共端点</p>
<p>openstack endpoint create –region RegionOne <br>  compute public <a href="http://openstackvip.com:8774/v2.1" target="_blank" rel="noopener">http://openstackvip.com:8774/v2.1</a></p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/201908221607110.png" alt="在这里插入图片描述"></p>
<ol start="4">
<li><p>创建私有端点</p>
<p>openstack endpoint create –region RegionOne  <br>  compute internal <a href="http://openstackvip.com:8774/v2.1" target="_blank" rel="noopener">http://openstackvip.com:8774/v2.1</a></p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/2019082216072774.png" alt="在这里插入图片描述"></p>
<ol start="5">
<li><p>创建管理端点</p>
<p>openstack endpoint create –region RegionOne <br>  compute admin <a href="http://openstackvip.com:8774/v2.1" target="_blank" rel="noopener">http://openstackvip.com:8774/v2.1</a></p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822160737790.png" alt="在这里插入图片描述"></p>
<ol start="10">
<li><p>编辑<code>/etc/nova/nova.conf</code></p>
<p>sed -i -e ‘/^#/d’ -e ‘/^$/d’ /etc/nova/nova.conf</p>
<p>vim /etc/nova/nova.conf</p>
</li>
</ol>
<p>详细配置：</p>
<pre><code>[DEFAULT]
my_ip = 192.168.99.101
use_neutron = true
firewall_driver = nova.virt.firewall.NoopFirewallDriver
enabled_apis = osapi_compute,metadata
transport_url = rabbit://openstack:123@openstackvip.com
rpc_backend=rabbit

[api]
auth_strategy=keystone

[api_database]
connection = mysql+pymysql://nova:123@openstackvip.com/nova_api

[database]
connection = mysql+pymysql://nova:123@openstackvip.com/nova

[glance]
api_servers = http://openstackvip.com:9292

[keystone_authtoken]
auth_url = http://openstackvip.com:5000/v3
memcached_servers = openstackvip.com:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = nova
password = 123

[oslo_concurrency]
lock_path = /var/lib/nova/tmp

[placement]
os_region_name = RegionOne
project_domain_name = default
project_name = service
auth_type = password
user_domain_name = default
auth_url = http://openstackvip.com:5000/v3
username = placement
password = 123

[vnc]
enabled = true
server_listen = $my_ip
server_proxyclient_address = $my_ip</code></pre><ol start="11">
<li><p>配置apache允许访问placement API</p>
<p>vim /etc/httpd/conf.d/00-placement-api.conf</p>
</li>
</ol>
<p>最下方添加以下配置：</p>
<pre><code>&lt;Directory /usr/bin&gt;
   &lt;IfVersion &gt;= 2.4&gt;
      Require all granted
   &lt;/IfVersion&gt;
   &lt;IfVersion &lt; 2.4&gt;
      Order allow,deny
      Allow from all
   &lt;/IfVersion&gt;
&lt;/Directory&gt;</code></pre><ol start="12">
<li><p>重启http</p>
<p>systemctl restart httpd</p>
</li>
<li><p>初始化数据库</p>
<p>#nova_api数据库<br>su -s /bin/sh -c “nova-manage api_db sync” nova</p>
<p>#nova cell0数据库<br>su -s /bin/sh -c “nova-manage cell_v2 map_cell0” nova</p>
<p>#nova cell1 数据库<br>su -s /bin/sh -c “nova-manage cell_v2 create_cell –name=cell1 –verbose” nova</p>
<p>#nova数据库<br>su -s /bin/sh -c “nova-manage db sync” nova</p>
</li>
<li><p>验证nova cell0和nova cell1是否正常注册</p>
<p>su -s /bin/sh -c “nova-manage cell_v2 list_cells” nova</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822160529397.png" alt="在这里插入图片描述"></p>
<ol start="15">
<li><p>启动并将nova服务设置为开机启动</p>
<p>systemctl enable openstack-nova-api.service <br>openstack-nova-consoleauth.service <br>openstack-nova-scheduler.service   <br>openstack-nova-conductor.service <br>openstack-nova-novncproxy.service</p>
<p>systemctl restart openstack-nova-api.service   <br>openstack-nova-consoleauth.service <br>openstack-nova-scheduler.service  <br>openstack-nova-conductor.service <br>openstack-nova-novncproxy.service</p>
</li>
<li><p>重启nova控制端脚本（nova-restart.sh）</p>
<p>#!/bin/bash<br>systemctl restart openstack-nova-api.service   openstack-nova-consoleauth.service openstack-nova-scheduler.service   openstack-nova-conductor.service openstack-nova-novncproxy.service</p>
<p>chmod  a+x nova-restart.sh</p>
</li>
</ol>
<hr>
<ol start="17">
<li><p>查看rabbitMQ连接 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822161208129.png" alt="在这里插入图片描述"></p>
</li>
<li><p>验证nova控制端</p>
<p>nova service-list</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822171147536.png" alt="在这里插入图片描述"></p>
<hr>
<h2 id="9-2-配置nova计算节点"><a href="#9-2-配置nova计算节点" class="headerlink" title="9.2. 配置nova计算节点"></a>9.2. 配置nova计算节点</h2><p>我的计算节点ip:192.168.99.10 注意：这个不是控制端，这是计算节点</p>
<ol>
<li><p>centos版本centos 7.2.1511 并开启虚拟化： <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824102538440.png" alt="在这里插入图片描述"></p>
</li>
<li><p>安装环境，在最前面</p>
</li>
<li><p>安装nova-compute包</p>
<p>yum -y install openstack-nova-compute</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822175242214.png" alt="在这里插入图片描述"></p>
<ol start="2">
<li><p>配置nova</p>
<p>sed -i -e ‘/^#/d’ -e ‘/^$/d’ /etc/nova/nova.conf</p>
<p>vim /etc/nova/nova.conf</p>
<p>#全部配置：<br>[DEFAULT]<br>my_ip = 192.168.99.23<br>use_neutron=true<br>firewall_driver=nova.virt.firewall.NoopFirewallDriver<br>enabled_apis=osapi_compute,metadata<br>transport_url = rabbit://openstack:<a href="mailto:123@openstackvip.com" target="_blank" rel="noopener">123@openstackvip.com</a></p>
<p>[api]<br>auth_strategy=keystone</p>
<p>[glance]<br>api_servers=<a href="http://openstackvip.com:9292" target="_blank" rel="noopener">http://openstackvip.com:9292</a></p>
<p>[keystone_authtoken]<br>auth_url = <a href="http://openstackvip.com:5000/v3" target="_blank" rel="noopener">http://openstackvip.com:5000/v3</a><br>memcached_servers = openstackvip.com:11211<br>auth_type = password<br>project_domain_name = default<br>user_domain_name = default<br>project_name = service<br>username = nova<br>password = 123</p>
<p>[oslo_concurrency]<br>lock_path=/var/lib/nova/tmp</p>
<p>[placement]<br>os_region_name = RegionOne<br>project_domain_name = default<br>project_name = service<br>auth_type = password<br>user_domain_name = default<br>auth_url = <a href="http://openstackvip.com:5000/v3" target="_blank" rel="noopener">http://openstackvip.com:5000/v3</a><br>username = placement<br>password = 123</p>
<p>[vnc]<br>enabled=true<br>server_listen=0.0.0.0<br>server_proxyclient_address = $my_ip<br>novncproxy_base_url=<a href="http://openstackvip.com:6080/vnc_auto.html" target="_blank" rel="noopener">http://openstackvip.com:6080/vnc_auto.html</a></p>
</li>
<li><p>确认计算节点是否支持硬件加速</p>
<p>egrep -c ‘(vmx|svm)’ /proc/cpuinfo</p>
<p>40</p>
</li>
</ol>
<p>如果此命令返回值zero，则您的计算节点不支持硬件加速，您必须配置libvirt为使用QEMU而不是KVM。 编辑文件中的[libvirt]部分，<code>/etc/nova/nova.conf</code>如下所示：</p>
<pre><code>[libvirt]
# ...
virt_type = qemu</code></pre><ol start="4">
<li><p>启动nova 计算服务并设置为开机启动</p>
<p>systemctl enable libvirtd.service openstack-nova-compute.service<br>systemctl restart libvirtd.service openstack-nova-compute.service</p>
</li>
</ol>
<p>Bash</p>
<p>Copy</p>
<hr>
<h3 id="9-2-1-控制端"><a href="#9-2-1-控制端" class="headerlink" title="9.2.1. 控制端"></a>9.2.1. 控制端</h3><ol>
<li><p>添加计算节点到cell 数据库</p>
<p>source  admin-openstack.sh<br>openstack compute service list –service nova-compute</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822210913280.png" alt="在这里插入图片描述"></p>
<ol start="6">
<li><p>主动发现计算节点 <strong>使用命令发现</strong></p>
<p>su -s /bin/sh -c “nova-manage cell_v2 discover_hosts –verbose” nova</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190822211003897.png" alt="在这里插入图片描述"> <strong>定期主动发现</strong></p>
<pre><code>vim /etc/nova/nova.conf</code></pre><p>加上这条</p>
<pre><code>[scheduler]
discover_hosts_in_cells_interval=300</code></pre><ol start="7">
<li><p>重启nova服务</p>
<p>bash nova-restart.sh </p>
</li>
</ol>
<hr>
<p>下面是验证：</p>
<ol start="8">
<li><p>验证1：列出服务组件以验证每个进程的成功启动和注册</p>
<p>[controller]$ openstack compute service list<br>+—-+——————+————+———-+———+——-+—————————-+<br>| ID | Binary           | Host       | Zone     | Status  | State | Updated At                 |<br>+—-+——————+————+———-+———+——-+—————————-+<br>|  1 | nova-consoleauth | controller | internal | enabled | up    | 2019-08-23T03:24:19.000000 |<br>|  2 | nova-scheduler   | controller | internal | enabled | up    | 2019-08-23T03:24:19.000000 |<br>|  3 | nova-conductor   | controller | internal | enabled | up    | 2019-08-23T03:24:13.000000 |<br>|  6 | nova-compute     | note1      | nova     | enabled | up    | 2019-08-23T03:24:19.000000 |<br>+—-+——————+————+———-+———+——-+—————————-+</p>
</li>
<li><p>验证2：列出Identity服务中的API端点以验证与Identity服务的连接</p>
<p>openstack catalog list</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823112544318.png" alt="在这里插入图片描述"></p>
<ol start="9">
<li><p>验证3：列出Image服务中的图像以验证与Image服务的连接</p>
<p>openstack image list</p>
<p>+————————————–+——–+——–+<br>| ID                                   | Name   | Status |<br>+————————————–+——–+——–+<br>| 7ae353f8-db19-4449-b4ac-df1e70fe96f7 | cirros | active |<br>+————————————–+——–+——–+</p>
</li>
<li><p>验证4：检查单元格和放置API是否正常运行以及其他必要的先决条件是否到位</p>
<p>nova-status upgrade check</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823112818250.png" alt="在这里插入图片描述"></p>
<hr>
<h1 id="10-配置neutron服务"><a href="#10-配置neutron服务" class="headerlink" title="10. 配置neutron服务"></a>10. 配置neutron服务</h1><h2 id="10-1-配置neutron控制节点"><a href="#10-1-配置neutron控制节点" class="headerlink" title="10.1. 配置neutron控制节点"></a>10.1. 配置neutron控制节点</h2><h3 id="10-1-1-在数据库服务器上创建"><a href="#10-1-1-在数据库服务器上创建" class="headerlink" title="10.1.1. 在数据库服务器上创建"></a>10.1.1. 在数据库服务器上创建</h3><p>要创建数据库，请完成以下步骤</p>
<pre><code>mysql -u root -p

MariaDB [(none)] CREATE DATABASE neutron;

MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO &apos;neutron&apos;@&apos;%&apos; \
  IDENTIFIED BY &apos;123&apos;;</code></pre><hr>
<h3 id="10-1-2-在控制端上"><a href="#10-1-2-在控制端上" class="headerlink" title="10.1.2. 在控制端上"></a>10.1.2. 在控制端上</h3><ol>
<li><p>创建neutron用户</p>
<p>openstack user create –domain default –password-prompt neutron</p>
</li>
<li><p>将admin角色添加到neutron用户</p>
<p>openstack role add –project service –user neutron admin</p>
</li>
<li><p>创建neutron服务实体</p>
<p>openstack service create –name neutron <br>  –description “OpenStack Networking” network</p>
</li>
<li><p>创建网络服务API端点</p>
<p>openstack endpoint create –region RegionOne <br>  network public <a href="http://openstackvip.com:9696" target="_blank" rel="noopener">http://openstackvip.com:9696</a></p>
<p>openstack endpoint create –region RegionOne <br>  network internal <a href="http://openstackvip.com:9696" target="_blank" rel="noopener">http://openstackvip.com:9696</a></p>
<p>openstack endpoint create –region RegionOne <br>  network admin <a href="http://openstackvip.com:9696" target="_blank" rel="noopener">http://openstackvip.com:9696</a></p>
</li>
</ol>
<p><strong>配置网络选项</strong> 5. 安装组件</p>
<pre><code>yum -y install openstack-neutron openstack-neutron-ml2 \
  openstack-neutron-linuxbridge ebtables</code></pre><p>配置服务器组件 6. 编辑neutron</p>
<pre><code>sed -i.bak -e &apos;/^#/d&apos; -e &apos;/^$/d&apos; /etc/neutron/neutron.conf

vim /etc/neutron/neutron.conf

[DEFAULT]
core_plugin = ml2
service_plugins =
transport_url = rabbit://openstack:123@openstackvip.com
auth_strategy = keystone
notify_nova_on_port_status_changes = true
notify_nova_on_port_data_changes = true

[cors]

[database]
connection = mysql+pymysql://neutron:123@openstackvip.com/neutron

[keystone_authtoken]
www_authenticate_uri = http://openstackvip.com:5000
auth_url = http://openstackvip.com:5000
memcached_servers = openstackvip.com:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = 123

[oslo_concurrency]
lock_path = /var/lib/neutron/tmp

[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[privsep]
[ssl]

[nova]
auth_url = http://openstackvip.com:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = nova
password = 123</code></pre><p><code>[nova]</code>这个选项没有，要手动加，在结尾加 配置模块化第2层（ML2）插件 7. 编辑ml2_conf.ini文件</p>
<pre><code>sed -i.bak -e &apos;/^#/d&apos; -e &apos;/^$/d&apos; /etc/neutron/plugins/ml2/ml2_conf.ini

vim /etc/neutron/plugins/ml2/ml2_conf.ini

[DEFAULT]

[ml2]
type_drivers = flat,vlan
tenant_network_types =
mechanism_drivers = linuxbridge
extension_drivers = port_security

[ml2_type_flat]
flat_networks = provider

[securitygroup]
enable_ipset = true</code></pre><p>配置Linux桥代理 8. 编辑linuxbridge_agent.ini文件</p>
<pre><code>sed -i.bak -e &apos;/^#/d&apos; -e &apos;/^$/d&apos; /etc/neutron/plugins/ml2/linuxbridge_agent.ini

vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini

[DEFAULT]

[linux_bridge]
physical_interface_mappings = provider:eth0

[vxlan]
enable_vxlan = false

[securitygroup]
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</code></pre><ol start="9">
<li><p>设置<code>/etc/sysctl.conf</code>文件</p>
<p>echo “net.bridge.bridge-nf-call-iptables = 1” &gt;&gt; /etc/sysctl.conf<br>echo “net.bridge.bridge-nf-call-ip6tables = 1” &gt;&gt; /etc/sysctl.conf</p>
</li>
</ol>
<p>生效</p>
<pre><code>sysctl -p</code></pre><p>这里会报错，不管</p>
<pre><code>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory
sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory</code></pre><p>配置DHCP代理 10. 编辑dhcp_agent.ini文件</p>
<pre><code>vim /etc/neutron/dhcp_agent.ini

[DEFAULT]
interface_driver = linuxbridge
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = true</code></pre><p>配置元数据代理 11. 编辑metadata_agent.ini文件</p>
<pre><code>vim /etc/neutron/metadata_agent.ini

[DEFAULT]
nova_metadata_host = 192.168.99.101
metadata_proxy_shared_secret = 123</code></pre><blockquote>
<p>nova_metadata_host写控制端ip，这里我们写vip，再由ha反向代理回来 metadata_proxy_shared_secret为元数据代理的密码</p>
</blockquote>
<p>配置Compute服务以使用Networking服务 12. 编辑<code>/etc/nova/nova.conf</code>文件</p>
<pre><code>vim /etc/nova/nova.conf</code></pre><p>在最后加上</p>
<pre><code>[neutron]
url = http://openstackvip.com:9696
auth_url = http://openstackvip.com:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = neutron
password = 123
service_metadata_proxy = true
metadata_proxy_shared_secret = 123</code></pre><blockquote>
<p>metadata_proxy_shared_secret 这是我们第11条里配置的密码</p>
</blockquote>
<ol start="13">
<li><p>网络服务初始化脚本需要一个<code>/etc/neutron/plugin.ini</code>指向ML2插件配置文件的符号链接<code>/etc/neutron/plugins/ml2/ml2_conf.ini</code>。</p>
<p>ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</p>
</li>
<li><p>填充数据库：</p>
<p>su -s /bin/sh -c “neutron-db-manage –config-file /etc/neutron/neutron.conf –config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head” neutron</p>
</li>
<li><p>重新启动Compute API服务：</p>
<p>systemctl restart openstack-nova-api.service</p>
</li>
<li><p>启动网络服务并将其配置为在系统引导时启动</p>
<p>systemctl enable neutron-server.service <br> neutron-linuxbridge-agent.service <br> neutron-dhcp-agent.service <br> neutron-metadata-agent.service</p>
<p>systemctl restart neutron-server.service <br> neutron-linuxbridge-agent.service <br> neutron-dhcp-agent.service <br> neutron-metadata-agent.service</p>
</li>
</ol>
<p>注：如果选择了<code>Self-service networks</code>，就需要启动第3层服务，我们选择的是<code>Provider networks</code>所以不需要</p>
<pre><code>systemctl enable neutron-l3-agent.service
systemctl restart neutron-l3-agent.service</code></pre><hr>
<h2 id="10-2-配置neutron计算节点"><a href="#10-2-配置neutron计算节点" class="headerlink" title="10.2. 配置neutron计算节点"></a>10.2. 配置neutron计算节点</h2><h3 id="10-2-1-计算节点上"><a href="#10-2-1-计算节点上" class="headerlink" title="10.2.1. 计算节点上"></a>10.2.1. 计算节点上</h3><ol>
<li><p>安装组件</p>
<p>yum -y install openstack-neutron-linuxbridge ebtables ipset</p>
</li>
</ol>
<p>配置公共组件 2. 编辑neutron.conf文件</p>
<pre><code>sed -i.bak -e &apos;/^#/d&apos; -e &apos;/^$/d&apos; /etc/neutron/neutron.conf

vim /etc/neutron/neutron.conf

[DEFAULT]
transport_url = rabbit://openstack:123@openstackvip.com
auth_strategy = keystone

[cors]
[database]
[keystone_authtoken]
www_authenticate_uri = http://openstackvip.com:5000
auth_url = http://openstackvip.com:5000
memcached_servers = openstackvip.com:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = 123

[oslo_concurrency]
lock_path = /var/lib/neutron/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[privsep]
[ssl]</code></pre><p>配置Linux桥代理 3. 编辑linuxbridge_agent.ini文件</p>
<pre><code>sed -i.bak -e &apos;/^#/d&apos; -e &apos;/^$/d&apos; /etc/neutron/plugins/ml2/linuxbridge_agent.ini

vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini


[DEFAULT]

[linux_bridge]
physical_interface_mappings = provider:eth0

[vxlan]
enable_vxlan = false

[securitygroup]
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</code></pre><p>确保您的Linux操作系统内核支持网桥过滤器 4. 配置<code>/etc/sysctl.conf</code>文件</p>
<pre><code>echo &quot;net.bridge.bridge-nf-call-iptables = 1&quot; &gt;&gt; /etc/sysctl.conf 
echo &quot;net.bridge.bridge-nf-call-ip6tables = 1&quot; &gt;&gt; /etc/sysctl.conf</code></pre><p>生效</p>
<pre><code>sysctl -p</code></pre><p>配置Compute服务以使用Networking服务 5. 编辑nova.conf文件</p>
<pre><code>vim /etc/nova/nova.conf

[neutron]
url = http://openstackvip.com:9696
auth_url = http://openstackvip.com:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = neutron
password = 123</code></pre><ol start="6">
<li><p>重新启动Compute服务：</p>
<p>systemctl restart openstack-nova-compute.service</p>
</li>
<li><p>启动Linux网桥代理并将其配置为在系统引导时启动：</p>
<p>systemctl enable neutron-linuxbridge-agent.service<br>systemctl restart neutron-linuxbridge-agent.service</p>
</li>
</ol>
<hr>
<h3 id="10-2-2-控制节点"><a href="#10-2-2-控制节点" class="headerlink" title="10.2.2. 控制节点"></a>10.2.2. 控制节点</h3><ol>
<li><p>验证</p>
<p>openstack extension list –network</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823161053511.png" alt="在这里插入图片描述"></p>
<ol start="2">
<li>openstack network agent list</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823161148819.png" alt="在这里插入图片描述"></p>
<hr>
<h1 id="11-创建实例"><a href="#11-创建实例" class="headerlink" title="11. 创建实例"></a>11. 创建实例</h1><h2 id="11-1-控制端"><a href="#11-1-控制端" class="headerlink" title="11.1. 控制端"></a>11.1. 控制端</h2><p>创建网络 1. 创建提供者网络(最后的provider是网络名)</p>
<pre><code>openstack network create  --share --external \
  --provider-physical-network provider \
  --provider-network-type flat provider</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/2019082317351970.png" alt="在这里插入图片描述"> 验证：</p>
<pre><code>openstack network list
#或
neutron net-list</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173530683.png" alt="在这里插入图片描述"></p>
<ol start="2">
<li><p>在网络上创建子网</p>
<p>openstack subnet create –network provider <br>  –allocation-pool start=192.168.99.200,end=192.168.99.210 <br>  –dns-nameserver 192.168.99.2 –gateway 192.168.99.2 <br>  –subnet-range 192.168.99.0/24 provider-sub</p>
</li>
</ol>
<blockquote>
<p>–network需要写你上面创建的网络名 provider-sub是子网名</p>
</blockquote>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173457792.png" alt="在这里插入图片描述"> 验证：</p>
<pre><code>openstack subnet list
#或
neutron subnet-list</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/2019082317344048.png" alt="在这里插入图片描述"></p>
<h2 id="11-2-创建实例类型"><a href="#11-2-创建实例类型" class="headerlink" title="11.2. 创建实例类型"></a>11.2. 创建实例类型</h2><pre><code>openstack flavor create --id 0 --vcpus 1 --ram 1024 --disk 10 m1.nano</code></pre><blockquote>
<p>–vcpus ：几个核的cpu –ram ：内存（单位M） –disk ：储存（单位G） 最后为类型名；</p>
</blockquote>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173421873.png" alt="在这里插入图片描述"> 查看类型列表</p>
<pre><code>openstack flavor list</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173547914.png" alt="在这里插入图片描述"> <strong>生成密钥对</strong> 1. 生成密钥对并添加公钥</p>
<pre><code>ssh-keygen -q -N &quot;&quot;
openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173602864.png" alt="在这里插入图片描述"> 验证密钥对的添加</p>
<pre><code>openstack keypair list</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173651439.png" alt="在这里插入图片描述"> <strong>添加安全组规则</strong> 2. 允许ICMP（ping）</p>
<pre><code>openstack security group rule create --proto icmp default</code></pre><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173703934.png" alt="在这里插入图片描述"></p>
<ol start="3">
<li><p>允许安全shell（SSH）访问：</p>
<p>openstack security group rule create –proto tcp –dst-port 22 default</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173732127.png" alt="在这里插入图片描述"></p>
<ol start="4">
<li><p>验证 查看类型</p>
<p>openstack flavor list</p>
</li>
</ol>
<p>查看镜像</p>
<pre><code>openstack image list</code></pre><p>列出可用网络</p>
<pre><code>openstack network list</code></pre><p>列出可用的安全组：</p>
<pre><code>openstack security group list</code></pre><ol start="5">
<li><p>启动实例</p>
<p>openstack server create –flavor m1.nano –image cirros <br>  –nic net-id=a57d2907-a59d-4422-b231-8d3c788d10d3  <br>  –security-group default <br>  –key-name mykey provider-instance</p>
</li>
</ol>
<blockquote>
<p>–flavor: 类型名称 –image: 镜像名称 –security-group：安全组名 PROVIDER_NET_ID替换网络ID <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823173944911.png" alt="在这里插入图片描述"> 最后provider-instance是实例名</p>
</blockquote>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823174117557.png" alt="在这里插入图片描述"></p>
<ol start="6">
<li><p>查看实例状态</p>
<p>openstack server list</p>
</li>
</ol>
<p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823174158246.png" alt="在这里插入图片描述"></p>
<ol start="7">
<li><p>使用虚拟控制台访问实例</p>
<p>openstack console url show provider-instance</p>
</li>
</ol>
<blockquote>
<p>provider-instance是你的实例名称 在浏览器使用url来连接实例</p>
</blockquote>
<hr>
<h1 id="12-配置Dashboard服务"><a href="#12-配置Dashboard服务" class="headerlink" title="12. 配置Dashboard服务"></a>12. 配置Dashboard服务</h1><p>horizon是openstack的管理其他组件的图形显示和操作界面，通过API和其他服务进行通讯，如镜像服务、计算服务和网络服务等结合使用，horizon基于python django开发，通过Apache的wsgi模块进行web访问通信，Horizon只需要更改配置文件连接到keyston即可</p>
<h2 id="12-1-控制端"><a href="#12-1-控制端" class="headerlink" title="12.1. 控制端"></a>12.1. 控制端</h2><ol>
<li><p>安装和配置组件</p>
<p>yum -y install openstack-dashboard</p>
</li>
<li><p>编辑 <code>/etc/openstack-dashboard/local_settings</code>文件 打开配置文件，搜索下面这些键，替换他们(下面提供sed命令) controller节点</p>
<p>OPENSTACK_HOST = “192.168.99.101”</p>
</li>
</ol>
<blockquote>
<p>OPENSTACK_HOST写控制端本机的IP</p>
</blockquote>
<p>启用Identity API版本3</p>
<pre><code>OPENSTACK_KEYSTONE_URL = &quot;http://%s:5000/v3&quot; % OPENSTACK_HOST</code></pre><p>配置user为通过仪表板创建的用户的默认角色：</p>
<pre><code>OPENSTACK_KEYSTONE_DEFAULT_ROLE = &quot;user&quot;</code></pre><p>接受所有主机</p>
<pre><code>ALLOWED_HOSTS = [&apos;*&apos;]</code></pre><p>配置memcached会话存储服务</p>
<pre><code>SESSION_ENGINE = &apos;django.contrib.sessions.backends.cache&apos;
CACHES = {
    &apos;default&apos;: {
         &apos;BACKEND&apos;: &apos;django.core.cache.backends.memcached.MemcachedCache&apos;,
         &apos;LOCATION&apos;: &apos;openstackvip.com:11211&apos;,
    }
}</code></pre><p>启用对域的支持：</p>
<pre><code>OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True</code></pre><p>配置API版本：</p>
<pre><code>OPENSTACK_API_VERSIONS = {
    &quot;identity&quot;: 3,
    &quot;image&quot;: 2,
    &quot;volume&quot;: 3,
}</code></pre><p>配置Default为通过仪表板创建的用户的默认域：</p>
<pre><code>OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &quot;default&quot;</code></pre><p>如果选择网络选项1，请禁用对第3层网络服务的支持：</p>
<pre><code>OPENSTACK_NEUTRON_NETWORK = {
    &apos;enable_router&apos;: False,
    &apos;enable_quotas&apos;: False,
    &apos;enable_distributed_router&apos;: False,
    &apos;enable_ha_router&apos;: False,
    &apos;enable_lb&apos;: False,
    &apos;enable_firewall&apos;: False,
    &apos;enable_vpn&apos;: False,
    &apos;enable_fip_topology_check&apos;: False,
}</code></pre><p>(可选)配置时区：</p>
<pre><code>TIME_ZONE = &quot;UTC&quot;</code></pre><p>sed一键配置</p>
<pre><code>sed -i.bak &apos;/^OPENSTACK_HOST/s#127.0.0.1#192.168.99.101#&apos; /etc/openstack-dashboard/local_settings
sed -i &apos;/^OPENSTACK_KEYSTONE_DEFAULT_ROLE/s#&quot;.*&quot;#&quot;user&quot;#&apos; /etc/openstack-dashboard/local_settings
sed -i &quot;/^ALLOWED_HOSTS/s#\[.*\]#[&apos;*&apos;]#&quot; /etc/openstack-dashboard/local_settings
sed -i &apos;/^#SESSION_ENGINE/s/#//&apos; /etc/openstack-dashboard/local_settings
sed -i &quot;/^SESSION_ENGINE/s#&apos;.*&apos;#&apos;django.contrib.sessions.backends.cache&apos;#&quot; /etc/openstack-dashboard/local_settings

sed -i &quot;/^#    &apos;default&apos;/s/#//&quot; /etc/openstack-dashboard/local_settings

sed -i &quot;/^#CACHES/,+6s/#//&quot; /etc/openstack-dashboard/local_settings
sed -i &quot;/^        &apos;LOCATION&apos;/s#127.0.0.1#openstackvip.com#&quot; /etc/openstack-dashboard/local_settings

sed -i &quot;/OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT/s/#//&quot; /etc/openstack-dashboard/local_settings
sed -i &quot;/OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT/s#False#True#&quot; /etc/openstack-dashboard/local_settings

sed -i &quot;/OPENSTACK_API_VERSIONS/,+5s/#//&quot; /etc/openstack-dashboard/local_settings
sed -i &apos;/&quot;compute&quot;/d&apos; /etc/openstack-dashboard/local_settings
sed -i &apos;/^#OPENSTACK_KEYSTONE_DEFAULT_DOMAIN/s/#//&apos; /etc/openstack-dashboard/local_settings 
sed -i &apos;/^OPENSTACK_KEYSTONE_DEFAULT_DOMAIN/s/Default/default/&apos; /etc/openstack-dashboard/local_settings
sed -i &apos;/^OPENSTACK_NEUTRON_NETWORK/,+7s#True#False#&apos; /etc/openstack-dashboard/local_settings
sed -i  &apos;/TIME_ZONE/s#UTC#UTC#&apos; /etc/openstack-dashboard/local_settings

sed -i  &quot;/^OPENSTACK_NEUTRON_NETWORK/s/$/\n    &apos;enable_lb&apos;: False,/&quot; /etc/openstack-dashboard/local_settings
sed -i  &quot;/^OPENSTACK_NEUTRON_NETWORK/s/$/\n    &apos;enable_firewall&apos;: False,/&quot; /etc/openstack-dashboard/local_settings
sed -i  &quot;/^OPENSTACK_NEUTRON_NETWORK/s/$/\n    &apos;enable_vpn&apos;: False,/&quot; /etc/openstack-dashboard/local_settings</code></pre><blockquote>
<p>继续配置下面的</p>
</blockquote>
<ol start="3">
<li><p>添加下行到配置文件<code>/etc/httpd/conf.d/openstack-dashboard.conf</code></p>
<p>vim /etc/httpd/conf.d/openstack-dashboard.conf</p>
<p>WSGIApplicationGroup %{GLOBAL}</p>
</li>
<li><p>重新启动Web服务器和会话存储服务()</p>
<p>systemctl restart httpd.service </p>
</li>
</ol>
<p>memcached我安装在其它机器上</p>
<pre><code>systemctl restart memcached.service</code></pre><ol start="4">
<li>浏览器<a href="http://controller_IP/dashboard" target="_blank" rel="noopener">http://controller_IP/dashboard</a> controller写你控制端的ip <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190823175738137.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<h1 id="13-配置cinder（块存储服务）"><a href="#13-配置cinder（块存储服务）" class="headerlink" title="13. 配置cinder（块存储服务）"></a>13. 配置cinder（块存储服务）</h1><p>监听端口：8776</p>
<h2 id="配置cinder控制器节点"><a href="#配置cinder控制器节点" class="headerlink" title="配置cinder控制器节点"></a>配置cinder控制器节点</h2><blockquote>
<ul>
<li>数据库端</li>
</ul>
</blockquote>
<pre><code>mysql -u root -p

MariaDB [(none)]&gt; CREATE DATABASE cinder;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO &apos;cinder&apos;@&apos;%&apos; \
  IDENTIFIED BY &apos;123&apos;;</code></pre><blockquote>
<ul>
<li>控制端</li>
</ul>
</blockquote>
<pre><code>. admin-openrc</code></pre><ol>
<li><p>创建cinder用户：</p>
<p>openstack user create –domain default –password-prompt cinder</p>
</li>
<li><p>将admin角色添加到cinder用户：</p>
<p>openstack role add –project service –user cinder admin</p>
</li>
<li><p>创建cinderv2和cinderv3服务实体</p>
<p>openstack service create –name cinderv2 <br>  –description “OpenStack Block Storage” volumev2</p>
<p>openstack service create –name cinderv3 <br>  –description “OpenStack Block Storage” volumev3</p>
</li>
<li><p>创建Block Storage服务API端点</p>
<p>openstack endpoint create –region RegionOne <br>  volumev2 public <a href="http://openstackvip.com:8776/v2/%\(project_id\)s" target="_blank" rel="noopener">http://openstackvip.com:8776/v2/%\(project_id\)s</a></p>
<p>openstack endpoint create –region RegionOne <br>  volumev2 internal <a href="http://openstackvip.com:8776/v2/%\(project_id\)s" target="_blank" rel="noopener">http://openstackvip.com:8776/v2/%\(project_id\)s</a></p>
<p>openstack endpoint create –region RegionOne <br>  volumev2 admin <a href="http://openstackvip.com:8776/v2/%\(project_id\)s" target="_blank" rel="noopener">http://openstackvip.com:8776/v2/%\(project_id\)s</a></p>
</li>
</ol>
<pre><code>openstack endpoint create --region RegionOne \
  volumev3 public http://openstackvip.com:8776/v3/%\(project_id\)s

openstack endpoint create --region RegionOne \
  volumev3 internal http://openstackvip.com:8776/v3/%\(project_id\)s

openstack endpoint create --region RegionOne \
  volumev3 admin http://openstackvip.com:8776/v3/%\(project_id\)s</code></pre><ol start="5">
<li><p>安装和配置组件</p>
<p>yum -y install openstack-cinder</p>
</li>
<li><p>编辑/etc/cinder/cinder.conf文件并完成以下操作</p>
<p>vim /etc/cinder/cinder.conf</p>
<p>[database]<br>my_ip = 10.0.0.11<br>connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder<br>transport_url = rabbit://openstack:RABBIT_PASS@controller<br>auth_strategy = keystone</p>
<p>[keystone_authtoken]</p>
<h1 id="…"><a href="#…" class="headerlink" title="…"></a>…</h1><p>www_authenticate_uri = <a href="http://controller:5000" target="_blank" rel="noopener">http://controller:5000</a><br>auth_url = <a href="http://controller:5000" target="_blank" rel="noopener">http://controller:5000</a><br>memcached_servers = controller:11211<br>auth_type = password<br>project_domain_name = default<br>user_domain_name = default<br>project_name = service<br>username = cinder<br>password = CINDER_PASS</p>
<p>[oslo_concurrency]</p>
<h1 id="…-1"><a href="#…-1" class="headerlink" title="…"></a>…</h1><p>lock_path = /var/lib/cinder/tmp</p>
</li>
<li><p>填充块存储数据库</p>
<p>su -s /bin/sh -c “cinder-manage db sync” cinder</p>
</li>
<li><p>配置计算以使用块存储 编辑/etc/nova/nova.conf文件</p>
<p>vim /etc/nova/nova.conf</p>
</li>
</ol>
<p>加上这个配置</p>
<pre><code>[cinder]
os_region_name = RegionOne</code></pre><ol start="9">
<li><p>重新启动Compute API服务</p>
<p>systemctl restart openstack-nova-api.service</p>
</li>
<li><p>启动Block Storage服务并将其配置为在系统引导时启动</p>
<p>systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service<br>systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service</p>
</li>
</ol>
<hr>
<h2 id="存储服务器"><a href="#存储服务器" class="headerlink" title="存储服务器"></a>存储服务器</h2><p>准备一台存储服务器，称之为“块存储”节点</p>
<blockquote>
<ul>
<li>“块存储”节点</li>
</ul>
</blockquote>
<ol>
<li><p>安装LVM包： yum install lvm2 device-mapper-persistent-data</p>
</li>
<li><p>启动LVM元数据服务 systemctl enable lvm2-lvmetad.service systemctl start lvm2-lvmetad.service</p>
</li>
<li><p>创建LVM物理卷/dev/sdb pvcreate /dev/sdb</p>
</li>
<li><p>创建LVM卷组cinder-volumes vgcreate cinder-volumes /dev/sdb</p>
</li>
<li><p>编辑lvm配置文件</p>
<p>vim /etc/lvm/lvm.conf</p>
</li>
</ol>
<p>找个下面这个字段修改</p>
<pre><code>devices {
...
filter = [ &quot;a/sdb/&quot;, &quot;r/.*/&quot;]</code></pre><blockquote>
<p>a是access，r是reject，只授受sdb磁盘</p>
</blockquote>
<ol start="6">
<li><p>安装包：</p>
<p>yum install openstack-cinder targetcli python-keystone</p>
</li>
<li><p>编辑cinder.conf文件</p>
<p>vim /etc/cinder/cinder.conf</p>
<p>[DEFAULT]<br>my_ip = 192.168.99.111<br>transport_url = rabbit://openstack:<a href="mailto:123@openstackvip.com" target="_blank" rel="noopener">123@openstackvip.com</a><br>auth_strategy = keystone<br>enabled_backends = lvm<br>glance_api_servers = <a href="http://openstackvip.com:9292" target="_blank" rel="noopener">http://openstackvip.com:9292</a></p>
<p>[database]<br>connection = mysql+pymysql://cinder:<a href="mailto:123@openstackvip.com" target="_blank" rel="noopener">123@openstackvip.com</a>/cinder</p>
<p>[keystone_authtoken]<br>www_authenticate_uri = <a href="http://openstackvip.com:5000" target="_blank" rel="noopener">http://openstackvip.com:5000</a><br>auth_url = <a href="http://openstackvip.com:5000" target="_blank" rel="noopener">http://openstackvip.com:5000</a><br>memcached_servers = openstackvip.com:11211<br>auth_type = password<br>project_domain_name = default<br>user_domain_name = default<br>project_name = service<br>username = cinder<br>password = 123</p>
<p>[lvm]<br>volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver<br>volume_group = cinder-volumes<br>target_protocol = iscsi<br>target_helper = lioadm<br>volume_backend_name = Openstack-lvm</p>
<p>[oslo_concurrency]<br>lock_path = /var/lib/cinder/tmp</p>
</li>
</ol>
<blockquote>
<p>my_ip写你的本机的IP</p>
</blockquote>
<ol start="8">
<li><p>启动Block Storage卷服务</p>
<p>systemctl enable openstack-cinder-volume.service target.service<br>systemctl start openstack-cinder-volume.service target.service</p>
</li>
</ol>
<h2 id="（可选）配置备份服务"><a href="#（可选）配置备份服务" class="headerlink" title="（可选）配置备份服务"></a>（可选）配置备份服务</h2><blockquote>
<ul>
<li>“块存储”节点</li>
</ul>
</blockquote>
<ol>
<li><p>安装包：</p>
<p>yum install openstack-cinder</p>
</li>
<li><p>编辑cinder.conf文件</p>
<p>vim /etc/cinder/cinder.conf</p>
<p>[DEFAULT]</p>
<h1 id="…-2"><a href="#…-2" class="headerlink" title="…"></a>…</h1><p>backup_driver = cinder.backup.drivers.swift<br>backup_swift_url = SWIFT_URL</p>
<p>openstack catalog show object-store</p>
</li>
<li><p>启动Block Storage备份服务</p>
<p>systemctl enable openstack-cinder-backup.service<br>systemctl start openstack-cinder-backup.service</p>
</li>
</ol>
<hr>
<h1 id="14-openstack高可用配置"><a href="#14-openstack高可用配置" class="headerlink" title="14. openstack高可用配置"></a>14. openstack高可用配置</h1><p><img src="http://www.pever.cn/wp-content/uploads/2019/10/20190824170043956.png" alt="在这里插入图片描述"></p>
<h2 id="14-1-NFS"><a href="#14-1-NFS" class="headerlink" title="14.1. NFS"></a>14.1. NFS</h2><p>IP:192.168.99.105 1. 安装nfs</p>
<pre><code>yum -y install nfs-utils</code></pre><ol start="2">
<li><p>添加用户</p>
<p>useradd openstack</p>
</li>
<li><p>修改配置文件</p>
<p>echo “/var/lib/glance/images 192.168.99.0/24(rw,all_squash,anonuid=<code>id -u openstack</code>,anongid=<code>id -g openstack</code>)” &gt; /etc/exports</p>
</li>
<li><p>创建文件</p>
<p>mkdir -p /var/lib/glance/images</p>
</li>
<li><p>启动服务</p>
<p>systemctl restart nfs-server<br>systemctl enable nfs-server<br>exportfs -r</p>
</li>
<li><p>验证下</p>
<p>showmount -e</p>
</li>
<li><p>给权限</p>
<p>chown -R openstack.openstack /var/lib/glance/images/</p>
</li>
</ol>
<h2 id="14-2-控制端挂载NFS"><a href="#14-2-控制端挂载NFS" class="headerlink" title="14.2. 控制端挂载NFS"></a>14.2. 控制端挂载NFS</h2><pre><code>showmount -e 192.168.99.115</code></pre><p>在挂载之前先保存下镜像</p>
<pre><code>mkdir /data ; mv /var/lib/glance/images/* /data</code></pre><p>挂载</p>
<pre><code>echo &quot;192.168.99.115:/var/lib/glance/images /var/lib/glance/images nfs defaults 0 0&quot; &gt;&gt; /etc/fstab
mount -a </code></pre><p>再把镜像移回来</p>
<pre><code>mv /data/* /var/lib/glance/images</code></pre><h2 id="14-3-haproxy高可用"><a href="#14-3-haproxy高可用" class="headerlink" title="14.3. haproxy高可用"></a>14.3. haproxy高可用</h2><p>需要的包haproxy + keepalived 在前面已经做了一台haproxy+keepalived，所以我们需要再加一台物理机，做backup。 IP: 192.168.99.104 开始配置 1. 安装</p>
<pre><code>yum -y install keepalived haproxy</code></pre><ol start="2">
<li><p>配置keepalived:</p>
<p>vim /etc/keepavlied/keepalived.conf</p>
<p>! Configuration File for keepalived</p>
<p>global_defs {<br>   notification_email {</p>
<pre><code>root@localhost</code></pre><p>   }<br>   notification_email_from keepalived@localhost<br>   smtp_server 127.0.0.1<br>   smtp_connect_timeout 30<br>   router_id ha_1<br>   vrrp_skip_check_adv_addr<br>   vrrp_strict<br>   vrrp_iptables<br>   vrrp_garp_interval 0<br>   vrrp_gna_interval 0<br>}<br>vrrp_instance VI_1 {</p>
<pre><code>state BACKUP
interface eth0
virtual_router_id 51
priority 90
advert_int 1
authentication {
    auth_type PASS
    auth_pass 1111
}
virtual_ipaddress {
    192.168.99.100 dev eth0 label eth0:1
}</code></pre><p>}</p>
</li>
<li><p>启动</p>
<p>systemctl start keepalived<br>systemctl enable keepalived</p>
</li>
<li><p>配置haproxy：</p>
</li>
</ol>
<p>在配置之前要看下需要做反向代理的端口</p>
<p>PORT</p>
<p>服务</p>
<p>5000</p>
<p>keystone</p>
<p>9292</p>
<p>glance</p>
<p>8778</p>
<p>placement</p>
<p>8774</p>
<p>nova</p>
<p>9696</p>
<p>neutron</p>
<p>6080</p>
<p>VNC</p>
<p>3306</p>
<p>MySQL</p>
<p>5672</p>
<p>rabbitMQ</p>
<p>15672</p>
<p>rabbitMQ_WEB</p>
<p>11211</p>
<p>memcached</p>
<p>这个配置在ha_1上也要加上</p>
<pre><code>vim /etc/haproxy/haproxy.conf

listen stats
        mode http
        bind :9999
        stats enable
        log global
        stats uri /haproxy-status
        stats auth admin:123

listen dashboard
        bind :80
        mode http
        balance source
        server dashboard 192.168.99.101:80 check inter 2000 fall 3 rise 5
        server dashboard 192.168.99.103:80 check inter 2000 fall 3 rise 5
listen mysql
        bind :3306
        mode tcp
        balance source
        server mysql 192.168.99.106:3306 check inter 2000 fall 3 rise 5

listen memcached
        bind :11211
        mode tcp
        balance source
        server memcached 192.168.99.106:11211 inter 2000 fall 3 rise 5
listen rabbit
        bind :5672
        mode tcp
        balance source
        server rabbit 192.168.99.106:5672 inter 2000 fall 3 rise 5
listen rabbit_web
        bind :15672
        mode http
        server rabbit_web 192.168.99.106:15672 inter 2000 fall 3 rise 5

listen keystone
        bind :5000
        mode tcp
        server keystone 192.168.99.101:5000 inter 2000 fall 3 rise 5
        server keystone 192.168.99.103:5000 inter 2000 fall 3 rise 5
listen glance
        bind :9292
        mode tcp
        server glance 192.168.99.101:9292 inter 2000 fall 3 rise 5
        server glance 192.168.99.103:9292 inter 2000 fall 3 rise 5
listen placement
        bind :8778
        mode tcp
        server placement 192.168.99.101:8778 inter 2000 fall 3 rise 5
        server placement 192.168.99.103:8778 inter 2000 fall 3 rise 5

listen neutron
        bind :9696
        mode tcp
        server neutron 192.168.99.101:9696 inter 2000 fall 3 rise 5
        server neutron 192.168.99.103:9696 inter 2000 fall 3 rise 5
listen nova
        bind :8774
        mode tcp
        server nova 192.168.99.101:8774 inter 2000 fall 3 rise 5
        server nova 192.168.99.103:8774 inter 2000 fall 3 rise 5
listen VNC
        bind :6080
        mode tcp
        server VNC 192.168.99.101:6080 inter 2000 fall 3 rise 5
        server VNC 192.168.99.103:6080 inter 2000 fall 3 rise 5</code></pre><h2 id="14-4-控制端的高可用"><a href="#14-4-控制端的高可用" class="headerlink" title="14.4. 控制端的高可用"></a>14.4. 控制端的高可用</h2><p>要实现高可以用，要再准备一台物理机，设置主机名为controller2， IP：192.168.99.113 从controller1准备这些文件</p>
<pre><code>$ ls
admin.keystone*  glance.tar                        keystone.tar  placement.tar
dashboard.tar    http_conf_d.tar                   neutron.tar   yum/
demo.keystone*   install_controller_openstack.sh*  nova.tar</code></pre><p>最终如图,yum源是centos安装时自带，如果你删除了也要从其它主机拷贝过来 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190827103209845.png" alt="在这里插入图片描述"> 准备的过程(在原有的controller上)</p>
<pre><code>#准备httpd
cd /etc/httpd/conf.d
tar cf /root/http_conf_d.tar *

#准备keystone
cd /etc/keystone
tar cf /root/keystone.tar *

#准备glance
cd /etc/glance
tar cf /root/glance.tar *

#准备placement
cd /etc/placement
tar cf /root/placement.tar *

#准备nova
cd /etc/nova
tar cf /root/nova.tar *

#准备neutron
cd /etc/neutron
tar cf /root/neutron.tar *

#准备dashboard
cd /etc/openstack-dashboard
tar cf /root/dashboard.tar *</code></pre><p>admin.keystone</p>
<pre><code>#!/bin/bash
export OS_PROJECT_DOMAIN_NAME=default
export OS_USER_DOMAIN_NAME=default
export OS_PROJECT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=123
export OS_AUTH_URL=http://openstackvip.com:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2</code></pre><p>demo.keystone</p>
<pre><code>#!/bin/bash
export OS_PROJECT_DOMAIN_NAME=default
export OS_USER_DOMAIN_NAME=default
export OS_PROJECT_NAME=demo
export OS_USERNAME=demo
export OS_PASSWORD=123
export OS_AUTH_URL=http://openstackvip.com:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2</code></pre><p>脚本内容，要先设置好主机名，主机名不能包含<code>_</code>下划线</p>
<pre><code>#!/bin/bash
gecho() {
    echo -e &quot;\e[1;32m${1}\e[0m&quot; &amp;&amp; sleep 1
}
recho() {
    echo -e &quot;\e[1;31m${1}\e[0m&quot; &amp;&amp; sleep 1
}

gecho &quot;配置yum源...&quot;
PWD=`dirname $0`
mkdir /etc/yum.repos.d/bak
mv /etc/yum.repos.d/* /etc/yum.repos.d/bak/
mv $PWD/yum/* /etc/yum.repos.d/
yum -y install centos-release-openstack-stein

gecho &quot;安装openstack客户端、openstack SELinux管理包...&quot;
yum -y install python-openstackclient openstack-selinux
yum -y install python2-PyMySQL mariadb
yum -y install openstack-keystone httpd mod_wsgi python-memcached

tar xf http_conf_d.tar -C /etc/httpd/conf.d

echo &quot;192.168.99.211 openstackvip.com&quot; &gt;&gt; /etc/hosts
echo &quot;192.168.99.211 controller&quot; &gt;&gt; /etc/hosts

gecho &quot;安装keystone...&quot;
tar xf $PWD/keystone.tar -C /etc/keystone

systemctl enable httpd.service
systemctl start httpd.service

gecho &quot;安装glance...&quot;
yum -y install openstack-glance

tar xf $PWD/glance.tar -C /etc/glance
systemctl enable openstack-glance-api.service openstack-glance-registry.service
systemctl start openstack-glance-api.service openstack-glance-registry.service

gecho &quot;安装placement...&quot;
yum -y install openstack-placement-api

tar xf $PWD/placement.tar -C /etc/placement


gecho &quot;安装nova。。。&quot;
yum -y install openstack-nova-api openstack-nova-conductor   openstack-nova-console openstack-nova-novncproxy  openstack-nova-scheduler openstack-nova-placement-api

tar xf $PWD/nova.tar -C /etc/nova

systemctl restart httpd

systemctl enable openstack-nova-api.service \
openstack-nova-consoleauth.service \
openstack-nova-scheduler.service   \
openstack-nova-conductor.service \
openstack-nova-novncproxy.service

systemctl restart openstack-nova-api.service   \
openstack-nova-consoleauth.service \
openstack-nova-scheduler.service  \
openstack-nova-conductor.service \
openstack-nova-novncproxy.service

cat &gt; /root/nova-restart.sh &lt;&lt;EOF
#!/bin/bash
systemctl restart openstack-nova-api.service   openstack-nova-consoleauth.service openstack-nova-scheduler.service   openstack-nova-conductor.service openstack-nova-novncproxy.service
EOF
chmod  a+x /root/nova-restart.sh

gecho &quot;安装neutron。。。&quot;
yum -y install openstack-neutron openstack-neutron-ml2 \
  openstack-neutron-linuxbridge ebtables

tar xf $PWD/neutron.tar -C /etc/neutron

echo &quot;net.bridge.bridge-nf-call-iptables = 1&quot; &gt;&gt; /etc/sysctl.conf
echo &quot;net.bridge.bridge-nf-call-ip6tables = 1&quot; &gt;&gt; /etc/sysctl.conf
sysctl -p

systemctl restart openstack-nova-api.service
systemctl enable neutron-server.service \
  neutron-linuxbridge-agent.service \
  neutron-dhcp-agent.service \
  neutron-metadata-agent.service

systemctl restart neutron-server.service \
  neutron-linuxbridge-agent.service \
  neutron-dhcp-agent.service \
  neutron-metadata-agent.service

gecho &quot;安装dashboard...&quot;
yum -y install openstack-dashboard
tar xf $PWD/dashboard.tar -C /etc/openstack-dashboard
systemctl restart httpd.service 

recho &quot;5秒后重启系统...&quot;
for i in `seq 5 -1 1` ; do
  tput sc
  echo -n $i
  sleep 1
  tput rc
  tput ed
done

reboot</code></pre><p>把之前所有的/etc/hosts改成</p>
<pre><code>192.168.99.211 openstackvip.com
192.168.99.211 controller</code></pre><h2 id="14-5-快速添加node节点"><a href="#14-5-快速添加node节点" class="headerlink" title="14.5. 快速添加node节点"></a>14.5. 快速添加node节点</h2><p>新的物理机，安装好centos7.2，配置好IP地址与主机名。 准备这些包 <img src="http://www.pever.cn/wp-content/uploads/2019/10/20190827143957233.png" alt="在这里插入图片描述"> 准备</p>
<pre><code>#准备neutron，在你原来的node节点上
cd /etc/neutron
tar cf /root/neutron-compute.tar *

#准备nova,在你原来的node节点上
cd /etc/nova
tar cf /root/nova-compute.tar *</code></pre><p>文件<code>limits.conf</code></p>
<pre><code># /etc/security/limits.conf
#
#This file sets the resource limits for the users logged in via PAM.
#It does not affect resource limits of the system services.
#
#Also note that configuration files in /etc/security/limits.d directory,
#which are read in alphabetical order, override the settings in this
#file in case the domain is the same or more specific.
#That means for example that setting a limit for wildcard domain here
#can be overriden with a wildcard setting in a config file in the
#subdirectory, but a user specific setting here can be overriden only
#with a user specific setting in the subdirectory.
#
#Each line describes a limit for a user in the form:
#
#&lt;domain&gt;        &lt;type&gt;  &lt;item&gt;  &lt;value&gt;
#
#Where:
#&lt;domain&gt; can be:
#        - a user name
#        - a group name, with @group syntax
#        - the wildcard *, for default entry
#        - the wildcard %, can be also used with %group syntax,
#                 for maxlogin limit
#
#&lt;type&gt; can have the two values:
#        - &quot;soft&quot; for enforcing the soft limits
#        - &quot;hard&quot; for enforcing hard limits
#
#&lt;item&gt; can be one of the following:
#        - core - limits the core file size (KB)
#        - data - max data size (KB)
#        - fsize - maximum filesize (KB)
#        - memlock - max locked-in-memory address space (KB)
#        - nofile - max number of open file descriptors
#        - rss - max resident set size (KB)
#        - stack - max stack size (KB)
#        - cpu - max CPU time (MIN)
#        - nproc - max number of processes
#        - as - address space limit (KB)
#        - maxlogins - max number of logins for this user
#        - maxsyslogins - max number of logins on the system
#        - priority - the priority to run user process with
#        - locks - max number of file locks the user can hold
#        - sigpending - max number of pending signals
#        - msgqueue - max memory used by POSIX message queues (bytes)
#        - nice - max nice priority allowed to raise to values: [-20, 19]
#        - rtprio - max realtime priority
#
#&lt;domain&gt;      &lt;type&gt;  &lt;item&gt;         &lt;value&gt;
#

#*               soft    core            0
#*               hard    rss             10000
#@student        hard    nproc           20
#@faculty        soft    nproc           20
#@faculty        hard    nproc           50
#ftp             hard    nproc           0
#@student        -       maxlogins       4

# End of file

*                soft    core               unlimited
*                hard    core             unlimited
*                soft    nproc            1000000
*                hard    nproc          1000000
*                soft    nofile            1000000
*                hard    nofile          1000000
*                soft    memlock      32000
*                hard    memlock    32000
*                soft    msgqueue    8192000
*                hard    msgqueue  8192000</code></pre><p>文件<code>profile</code></p>
<pre><code># /etc/profile

# System wide environment and startup programs, for login setup
# Functions and aliases go in /etc/bashrc

# It&apos;s NOT a good idea to change this file unless you know what you
# are doing. It&apos;s much better to create a custom.sh shell script in
# /etc/profile.d/ to make custom changes to your environment, as this
# will prevent the need for merging in future updates.

pathmunge () {
    case &quot;:${PATH}:&quot; in
        *:&quot;$1&quot;:*)
            ;;
        *)
            if [ &quot;$2&quot; = &quot;after&quot; ] ; then
                PATH=$PATH:$1
            else
                PATH=$1:$PATH
            fi
    esac
}


if [ -x /usr/bin/id ]; then
    if [ -z &quot;$EUID&quot; ]; then
        # ksh workaround
        EUID=`id -u`
        UID=`id -ru`
    fi
    USER=&quot;`id -un`&quot;
    LOGNAME=$USER
    MAIL=&quot;/var/spool/mail/$USER&quot;
fi

# Path manipulation
if [ &quot;$EUID&quot; = &quot;0&quot; ]; then
    pathmunge /usr/sbin
    pathmunge /usr/local/sbin
else
    pathmunge /usr/local/sbin after
    pathmunge /usr/sbin after
fi

HOSTNAME=`/usr/bin/hostname 2&gt;/dev/null`
HISTSIZE=1000
if [ &quot;$HISTCONTROL&quot; = &quot;ignorespace&quot; ] ; then
    export HISTCONTROL=ignoreboth
else
    export HISTCONTROL=ignoredups
fi

export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE HISTCONTROL

# By default, we want umask to get set. This sets it for login shell
# Current threshold for system reserved uid/gids is 200
# You could check uidgid reservation validity in
# /usr/share/doc/setup-*/uidgid file
if [ $UID -gt 199 ] &amp;&amp; [ &quot;`id -gn`&quot; = &quot;`id -un`&quot; ]; then
    umask 002
else
    umask 022
fi

for i in /etc/profile.d/*.sh ; do
    if [ -r &quot;$i&quot; ]; then
        if [ &quot;${-#*i}&quot; != &quot;$-&quot; ]; then 
            . &quot;$i&quot;
        else
            . &quot;$i&quot; &gt;/dev/null
        fi
    fi
done

unset i
unset -f pathmunge

export HISTTIMEFORMAT=&quot;%F %T `whoami` &quot;</code></pre><p>文件<code>sysctl.conf</code></p>
<pre><code>net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1</code></pre><p>脚本<code>openstack_node_script.sh</code></p>
<pre><code>#!/bin/bash
gecho() {
    echo -e &quot;\e[1;32m${1}\e[0m&quot; &amp;&amp; sleep 1
}
recho() {
    echo -e &quot;\e[1;31m${1}\e[0m&quot; &amp;&amp; sleep 1
}

vip=192.168.99.211
controller_ip=192.168.99.211

gecho &quot;配置yum源&quot;
PWD=`dirname $0`
mkdir /etc/yum.repos.d/bak
mv /etc/yum.repos.d/* /etc/yum.repos.d/bak/
mv $PWD/yum/* /etc/yum.repos.d/

gecho &quot;安装包...&quot;
yum -y install centos-release-openstack-stein
yum -y install python-openstackclient openstack-selinux
yum -y install openstack-nova-compute
yum -y install openstack-neutron-linuxbridge ebtables ipset

cat $PWD/limits.conf &gt; /etc/security/limits.conf
cat $PWD/profile &gt; /etc/profile
cat $PWD/sysctl.conf &gt; /etc/sysctl.conf

gecho &quot;配置nova&quot;
tar xvf $PWD/nova-compute.tar -C /etc/nova/
myip=`ifconfig eth0 | awk &apos;/inet /{print $2}&apos;`
sed -i &quot;/my_ip =/s#.*#my_ip = ${myip}#&quot; /etc/nova/nova.conf

gecho &quot;配置neutron&quot;
tar xf neutron-compute.tar -C /etc/neutron

echo &quot;net.bridge.bridge-nf-call-iptables = 1&quot; &gt;&gt; /etc/sysctl.conf
echo &quot;net.bridge.bridge-nf-call-ip6tables = 1&quot; &gt;&gt; /etc/sysctl.conf
sysctl -p

echo &quot;${vip} openstackvip.com&quot; &gt;&gt; /etc/hosts
echo &quot;${controller_ip} controller&quot; &gt;&gt; /etc/hosts

vcpu=${egrep -c &apos;(vmx|svm)&apos; /proc/cpuinfo}
if [ vcpu -eq 0 ] ; then
cat &gt;&gt; /etc/nova/nova.conf &lt;&lt;EOF
[libvirt]
virt_type = qemu
EOF
fi

gecho &quot;启动服务...&quot;
systemctl enable libvirtd.service openstack-nova-compute.service
systemctl restart libvirtd.service || recho &quot;libvirtd启动失败&quot;
systemctl restart openstack-nova-compute.service || recho &quot;openstack-nova-compute启动失败&quot;
systemctl enable neutron-linuxbridge-agent.service
systemctl restart neutron-linuxbridge-agent.service


recho &quot;5秒后重启系统...&quot;
for i in `seq 5 -1 1` ; do
  tput sc
  echo -n $i
  sleep 1
  tput rc
  tput ed
done

reboot</code></pre>
    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/10/31/kvm-e4-b8-89-e5-88-9b-e5-bb-ba-e8-99-9a-e6-8b-9f-e6-9c-ba/" rel="next" title="KVM(三)_创建虚拟机">
                  <i class="fa fa-chevron-left"></i> KVM(三)_创建虚拟机
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/11/03/trashed-2/" rel="prev" title="Linux基础_软件包管理">
                  Linux基础_软件包管理 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-openstack介绍"><span class="nav-number">1.</span> <span class="nav-text">1. openstack介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-云计算模式"><span class="nav-number">1.1.</span> <span class="nav-text">1.1. 云计算模式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-OpenStack-中有哪些项目？"><span class="nav-number">2.</span> <span class="nav-text">2. OpenStack 中有哪些项目？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Openstack创建实例的流程"><span class="nav-number">2.1.</span> <span class="nav-text">2.1. Openstack创建实例的流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-总图"><span class="nav-number">2.2.</span> <span class="nav-text">2.2. 总图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-openstack项目搭建"><span class="nav-number">3.</span> <span class="nav-text">3. openstack项目搭建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-环境配置"><span class="nav-number">4.</span> <span class="nav-text">4. 环境配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-配置SQL数据库"><span class="nav-number">4.1.</span> <span class="nav-text">4.1. 配置SQL数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-配置Memcached"><span class="nav-number">4.2.</span> <span class="nav-text">4.2. 配置Memcached</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-安装rabbit-MQ"><span class="nav-number">4.3.</span> <span class="nav-text">4.3. 安装rabbit-MQ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-配置haproxy-keepalived"><span class="nav-number">5.</span> <span class="nav-text">5. 配置haproxy+keepalived</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-配置keystone认证服务"><span class="nav-number">6.</span> <span class="nav-text">6. 配置keystone认证服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-数据库：106"><span class="nav-number">6.1.</span> <span class="nav-text">6.1. 数据库：106</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-控制端-101"><span class="nav-number">6.2.</span> <span class="nav-text">6.2. 控制端: 101</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-配置glance服务"><span class="nav-number">7.</span> <span class="nav-text">7. 配置glance服务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-配置placement服务"><span class="nav-number">8.</span> <span class="nav-text">8. 配置placement服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-数据库"><span class="nav-number">8.1.</span> <span class="nav-text">8.1. 数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-控制端"><span class="nav-number">8.2.</span> <span class="nav-text">8.2. 控制端</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-配置nova"><span class="nav-number">9.</span> <span class="nav-text">9. 配置nova</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-配置nova控制节点"><span class="nav-number">9.1.</span> <span class="nav-text">9.1. 配置nova控制节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-1-安装并配置nova控制节点"><span class="nav-number">9.1.1.</span> <span class="nav-text">9.1.1. 安装并配置nova控制节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-2-在控制端"><span class="nav-number">9.1.2.</span> <span class="nav-text">9.1.2. 在控制端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-配置nova计算节点"><span class="nav-number">9.2.</span> <span class="nav-text">9.2. 配置nova计算节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-1-控制端"><span class="nav-number">9.2.1.</span> <span class="nav-text">9.2.1. 控制端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-配置neutron服务"><span class="nav-number">10.</span> <span class="nav-text">10. 配置neutron服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-配置neutron控制节点"><span class="nav-number">10.1.</span> <span class="nav-text">10.1. 配置neutron控制节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-1-在数据库服务器上创建"><span class="nav-number">10.1.1.</span> <span class="nav-text">10.1.1. 在数据库服务器上创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-2-在控制端上"><span class="nav-number">10.1.2.</span> <span class="nav-text">10.1.2. 在控制端上</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-配置neutron计算节点"><span class="nav-number">10.2.</span> <span class="nav-text">10.2. 配置neutron计算节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-1-计算节点上"><span class="nav-number">10.2.1.</span> <span class="nav-text">10.2.1. 计算节点上</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-2-控制节点"><span class="nav-number">10.2.2.</span> <span class="nav-text">10.2.2. 控制节点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-创建实例"><span class="nav-number">11.</span> <span class="nav-text">11. 创建实例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-控制端"><span class="nav-number">11.1.</span> <span class="nav-text">11.1. 控制端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2-创建实例类型"><span class="nav-number">11.2.</span> <span class="nav-text">11.2. 创建实例类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12-配置Dashboard服务"><span class="nav-number">12.</span> <span class="nav-text">12. 配置Dashboard服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#12-1-控制端"><span class="nav-number">12.1.</span> <span class="nav-text">12.1. 控制端</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#13-配置cinder（块存储服务）"><span class="nav-number">13.</span> <span class="nav-text">13. 配置cinder（块存储服务）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置cinder控制器节点"><span class="nav-number">13.1.</span> <span class="nav-text">配置cinder控制器节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#…"><span class="nav-number">14.</span> <span class="nav-text">…</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#…-1"><span class="nav-number">15.</span> <span class="nav-text">…</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#存储服务器"><span class="nav-number">15.1.</span> <span class="nav-text">存储服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#（可选）配置备份服务"><span class="nav-number">15.2.</span> <span class="nav-text">（可选）配置备份服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#…-2"><span class="nav-number">16.</span> <span class="nav-text">…</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#14-openstack高可用配置"><span class="nav-number">17.</span> <span class="nav-text">14. openstack高可用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#14-1-NFS"><span class="nav-number">17.1.</span> <span class="nav-text">14.1. NFS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-2-控制端挂载NFS"><span class="nav-number">17.2.</span> <span class="nav-text">14.2. 控制端挂载NFS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-3-haproxy高可用"><span class="nav-number">17.3.</span> <span class="nav-text">14.3. haproxy高可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-4-控制端的高可用"><span class="nav-number">17.4.</span> <span class="nav-text">14.4. 控制端的高可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-5-快速添加node节点"><span class="nav-number">17.5.</span> <span class="nav-text">14.5. 快速添加node节点</span></a></li></ol></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">92</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span>
        
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
        
      </div>
    
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">
      
    Theme – <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.1
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/muse.js?v=7.4.1"></script>
<script src="/js/next-boot.js?v=7.4.1"></script>



  





















  

  

  

</body>
</html>
